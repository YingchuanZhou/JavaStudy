# MongoDB

**è¯¾ç¨‹ç›®æ ‡**

MongoDBçš„å‰¯æœ¬é›†: æ“ä½œ, ä¸»è¦æ¦‚å¿µ, æ•…éšœè½¬ç§», é€‰ä¸¾è§„åˆ™ MongoDBçš„åˆ†ç‰‡é›†ç¾¤ï¼šæ¦‚å¿µ, ä¼˜ç‚¹, æ“ä½œ, åˆ†ç‰‡ç­–ç•¥, æ•…éšœè½¬ç§» MongoDBçš„å®‰å…¨è®¤è¯

- ç†è§£ MongoDB çš„ä¸šåŠ¡åœºæ™¯, ç†Ÿæ‚‰ MongoDB çš„ç®€ä»‹, ç‰¹ç‚¹å’Œä½“ç³»ç»“æ„, æ•°æ®ç±»å‹ç­‰.
- èƒ½å¤Ÿåœ¨ Windows å’Œ Linux ä¸‹å®‰è£…å’Œå¯åŠ¨ MongoDB, å›¾å½¢åŒ–ç®¡ç†ç•Œé¢ Compass çš„å®‰è£…ä½¿ç”¨
- æŒæ¡ MongoDB åŸºæœ¬å¸¸ç”¨å‘½ä»¤å®ç°æ•°æ®çš„ CRUD
- æŒæ¡ MongoDB çš„ç´¢å¼•ç±»å‹, ç´¢å¼•ç®¡ç†, æ‰§è¡Œè®¡åˆ’

## 1. MongoDB ç›¸å…³æ¦‚å¿µ

### 1.1 ä¸šåŠ¡åœºæ™¯

ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ (æ¯”å¦‚ MySQL), åœ¨æ•°æ®æ“ä½œçš„â€ä¸‰é«˜â€éœ€æ±‚ä»¥åŠå¯¹åº”çš„ Web 2.0 ç½‘ç«™éœ€æ±‚é¢å‰, ä¼šæœ‰â€åŠ›ä¸ä»å¿ƒâ€çš„æ„Ÿè§‰

æ‰€è°“çš„ä¸‰é«˜éœ€æ±‚:

**é«˜å¹¶å‘, é«˜æ€§èƒ½, é«˜å¯ç”¨**, ç®€ç§°ä¸‰é«˜

- High Performance: å¯¹æ•°æ®åº“çš„é«˜å¹¶å‘è¯»å†™çš„è¦æ±‚
- High Storage: å¯¹æµ·é‡æ•°æ®çš„é«˜æ•ˆç‡å­˜å‚¨å’Œè®¿é—®çš„éœ€æ±‚
- High Scalability && High Available: å¯¹æ•°æ®çš„é«˜æ‰©å±•æ€§å’Œé«˜å¯ç”¨æ€§çš„éœ€æ±‚

**è€Œ MongoDB å¯ä»¥åº”å¯¹ä¸‰é«˜éœ€æ±‚**

å…·ä½“çš„åº”ç”¨åœºæ™¯:

- ç¤¾äº¤åœºæ™¯, ä½¿ç”¨ MongoDB å­˜å‚¨å­˜å‚¨ç”¨æˆ·ä¿¡æ¯, ä»¥åŠç”¨æˆ·å‘è¡¨çš„æœ‹å‹åœˆä¿¡æ¯, é€šè¿‡åœ°ç†ä½ç½®ç´¢å¼•å®ç°é™„è¿‘çš„äºº, åœ°ç‚¹ç­‰åŠŸèƒ½.
- æ¸¸æˆåœºæ™¯, ä½¿ç”¨ MongoDB å­˜å‚¨æ¸¸æˆç”¨æˆ·ä¿¡æ¯, ç”¨æˆ·çš„è£…å¤‡, ç§¯åˆ†ç­‰ç›´æ¥ä»¥å†…åµŒæ–‡æ¡£çš„å½¢å¼å­˜å‚¨, æ–¹ä¾¿æŸ¥è¯¢, é«˜æ•ˆç‡å­˜å‚¨å’Œè®¿é—®.
- ç‰©æµåœºæ™¯, ä½¿ç”¨ MongoDB å­˜å‚¨è®¢å•ä¿¡æ¯, è®¢å•çŠ¶æ€åœ¨è¿é€è¿‡ç¨‹ä¸­ä¼šä¸æ–­æ›´æ–°, ä»¥ MongoDB å†…åµŒæ•°ç»„çš„å½¢å¼æ¥å­˜å‚¨, ä¸€æ¬¡æŸ¥è¯¢å°±èƒ½å°†è®¢å•æ‰€æœ‰çš„å˜æ›´è¯»å–å‡ºæ¥.
- ç‰©è”ç½‘åœºæ™¯, ä½¿ç”¨ MongoDB å­˜å‚¨æ‰€æœ‰æ¥å…¥çš„æ™ºèƒ½è®¾å¤‡ä¿¡æ¯, ä»¥åŠè®¾å¤‡æ±‡æŠ¥çš„æ—¥å¿—ä¿¡æ¯, å¹¶å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œå¤šç»´åº¦çš„åˆ†æ.
- è§†é¢‘ç›´æ’­, ä½¿ç”¨ MongoDB å­˜å‚¨ç”¨æˆ·ä¿¡æ¯, ç‚¹èµäº’åŠ¨ä¿¡æ¯ç­‰.

è¿™äº›åº”ç”¨åœºæ™¯ä¸­, æ•°æ®æ“ä½œæ–¹é¢çš„å…±åŒç‚¹æœ‰:

1. æ•°æ®é‡å¤§
2. å†™å…¥æ“ä½œé¢‘ç¹
3. ä»·å€¼è¾ƒä½çš„æ•°æ®, å¯¹**äº‹åŠ¡æ€§**è¦æ±‚ä¸é«˜

å¯¹äºè¿™æ ·çš„æ•°æ®, æ›´é€‚åˆç”¨ MongoDB æ¥å®ç°æ•°æ®å­˜å‚¨

é‚£ä¹ˆæˆ‘ä»¬**ä»€ä¹ˆæ—¶å€™é€‰æ‹© MongoDB å‘¢?**

é™¤äº†æ¶æ„é€‰å‹ä¸Š, é™¤äº†ä¸Šè¿°ä¸‰ä¸ªç‰¹ç‚¹ä¹‹å¤–, è¿˜è¦è€ƒè™‘ä¸‹é¢è¿™äº›é—®é¢˜:

- åº”ç”¨ä¸éœ€è¦äº‹åŠ¡åŠå¤æ‚ JOIN æ”¯æŒ
- æ–°åº”ç”¨, éœ€æ±‚ä¼šå˜, æ•°æ®æ¨¡å‹æ— æ³•ç¡®å®š, æƒ³å¿«é€Ÿè¿­ä»£å¼€å‘
- åº”ç”¨éœ€è¦ 2000 - 3000 ä»¥ä¸Šçš„è¯»å†™QPSï¼ˆæ›´é«˜ä¹Ÿå¯ä»¥ï¼‰
- åº”ç”¨éœ€è¦ TB ç”šè‡³ PB çº§åˆ«æ•°æ®å­˜å‚¨
- åº”ç”¨å‘å±•è¿…é€Ÿ, éœ€è¦èƒ½å¿«é€Ÿæ°´å¹³æ‰©å±•
- åº”ç”¨è¦æ±‚å­˜å‚¨çš„æ•°æ®ä¸ä¸¢å¤±
- åº”ç”¨éœ€è¦ `99.999%` é«˜å¯ç”¨
- åº”ç”¨éœ€è¦å¤§é‡çš„åœ°ç†ä½ç½®æŸ¥è¯¢, æ–‡æœ¬æŸ¥è¯¢

å¦‚æœä¸Šè¿°æœ‰1ä¸ªç¬¦åˆ, å¯ä»¥è€ƒè™‘ MongoDB, 2ä¸ªåŠä»¥ä¸Šçš„ç¬¦åˆ, é€‰æ‹© MongoDB ç»ä¸ä¼šåæ‚”.

> å¦‚æœç”¨MySQLå‘¢?
>
> ç›¸å¯¹MySQL, å¯ä»¥ä»¥æ›´ä½çš„æˆæœ¬è§£å†³é—®é¢˜ï¼ˆåŒ…æ‹¬å­¦ä¹ , å¼€å‘, è¿ç»´ç­‰æˆæœ¬ï¼‰

### 1.2 MongoDB ç®€ä»‹

> MongoDBæ˜¯ä¸€ä¸ªå¼€æº, é«˜æ€§èƒ½, æ— æ¨¡å¼çš„æ–‡æ¡£å‹æ•°æ®åº“, å½“åˆçš„è®¾è®¡å°±æ˜¯ç”¨äºç®€åŒ–å¼€å‘å’Œæ–¹ä¾¿æ‰©å±•, æ˜¯NoSQLæ•°æ®åº“äº§å“ä¸­çš„ä¸€ç§.æ˜¯æœ€ åƒå…³ç³»å‹æ•°æ®åº“ï¼ˆMySQLï¼‰çš„éå…³ç³»å‹æ•°æ®åº“. å®ƒæ”¯æŒçš„æ•°æ®ç»“æ„éå¸¸æ¾æ•£, æ˜¯ä¸€ç§ç±»ä¼¼äº JSON çš„ æ ¼å¼å«BSON, æ‰€ä»¥å®ƒæ—¢å¯ä»¥å­˜å‚¨æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç±»å‹, åˆç›¸å½“çš„çµæ´». MongoDBä¸­çš„è®°å½•æ˜¯ä¸€ä¸ªæ–‡æ¡£, å®ƒæ˜¯ä¸€ä¸ªç”±å­—æ®µå’Œå€¼å¯¹ï¼ˆï¬eld:valueï¼‰ç»„æˆçš„æ•°æ®ç»“æ„.MongoDBæ–‡æ¡£ç±»ä¼¼äºJSONå¯¹è±¡, å³ä¸€ä¸ªæ–‡æ¡£è®¤ ä¸ºå°±æ˜¯ä¸€ä¸ªå¯¹è±¡.å­—æ®µçš„æ•°æ®ç±»å‹æ˜¯å­—ç¬¦å‹, å®ƒçš„å€¼é™¤äº†ä½¿ç”¨åŸºæœ¬çš„ä¸€äº›ç±»å‹å¤–, è¿˜å¯ä»¥åŒ…æ‹¬å…¶ä»–æ–‡æ¡£, æ™®é€šæ•°ç»„å’Œæ–‡æ¡£æ•°ç»„.

**â€œæœ€åƒå…³ç³»å‹æ•°æ®åº“çš„ NoSQL æ•°æ®åº“â€**. MongoDB ä¸­çš„è®°å½•æ˜¯ä¸€ä¸ªæ–‡æ¡£, æ˜¯ä¸€ä¸ª key-value pair. å­—æ®µçš„æ•°æ®ç±»å‹æ˜¯å­—ç¬¦å‹, å€¼é™¤äº†ä½¿ç”¨åŸºæœ¬çš„ä¸€äº›ç±»å‹ä»¥å¤–, è¿˜åŒ…æ‹¬å…¶å®ƒæ–‡æ¡£, æ™®é€šæ•°ç»„ä»¥åŠæ–‡æ¡£æ•°ç»„

MongoDB æ•°æ®æ¨¡å‹æ˜¯é¢å‘æ–‡æ¡£çš„, æ‰€è°“æ–‡æ¡£å°±æ˜¯ä¸€ç§ç±»ä¼¼äº JSON çš„ç»“æ„, ç®€å•ç†è§£ MongoDB è¿™ä¸ªæ•°æ®åº“ä¸­å­˜åœ¨çš„æ˜¯å„ç§å„æ ·çš„ JSONï¼ˆBSONï¼‰

- æ•°æ®åº“ (database)
  - æ•°æ®åº“æ˜¯ä¸€ä¸ªä»“åº“, å­˜å‚¨é›†åˆ (collection)
- é›†åˆ (collection)
  - ç±»ä¼¼äºæ•°ç»„, åœ¨é›†åˆä¸­å­˜æ”¾æ–‡æ¡£
- æ–‡æ¡£ (document)
  - æ–‡æ¡£å‹æ•°æ®åº“çš„æœ€å°å•ä½, é€šå¸¸æƒ…å†µ, æˆ‘ä»¬å­˜å‚¨å’Œæ“ä½œçš„å†…å®¹éƒ½æ˜¯æ–‡æ¡£

åœ¨ MongoDB ä¸­, æ•°æ®åº“å’Œé›†åˆéƒ½ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»º, å½“æˆ‘ä»¬åˆ›å»ºæ–‡æ¡£æ—¶, å¦‚æœæ–‡æ¡£æ‰€åœ¨çš„é›†åˆæˆ–è€…æ•°æ®åº“ä¸å­˜åœ¨, **åˆ™ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“æˆ–è€…é›†åˆ**

### æ•°æ®åº“ (databases) ç®¡ç†è¯­æ³•

| æ“ä½œ                                            | è¯­æ³•                             |
| ----------------------------------------------- | -------------------------------- |
| æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“                                  | `show dbs;` æˆ– `show databases;` |
| æŸ¥çœ‹å½“å‰æ•°æ®åº“                                  | `db;`                            |
| åˆ‡æ¢åˆ°æŸæ•°æ®åº“ (**è‹¥æ•°æ®åº“ä¸å­˜åœ¨åˆ™åˆ›å»ºæ•°æ®åº“**) | `use <db_name>;`                 |
| åˆ é™¤å½“å‰æ•°æ®åº“                                  | `db.dropDatabase();`             |

### é›†åˆ (collection) ç®¡ç†è¯­æ³•

| æ“ä½œ         | è¯­æ³•                                        |
| ------------ | ------------------------------------------- |
| æŸ¥çœ‹æ‰€æœ‰é›†åˆ | `show collections;`                         |
| åˆ›å»ºé›†åˆ     | `db.createCollection("<collection_name>");` |
| åˆ é™¤é›†åˆ     | `db.<collection_name>.drop()`               |

### 1.3. æ•°æ®æ¨¡å‹

![img](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/image-20200505220650827.png)

### 1.4 MongoDB çš„ç‰¹ç‚¹

#### 1.4.1 é«˜æ€§èƒ½

MongoDB æä¾›é«˜æ€§èƒ½çš„æ•°æ®æŒä¹…åŒ–

- åµŒå…¥å¼æ•°æ®æ¨¡å‹çš„æ”¯æŒå‡å°‘äº†æ•°æ®åº“ç³»ç»Ÿä¸Šçš„ I/O æ´»åŠ¨
- ç´¢å¼•æ”¯æŒæ›´å¿«çš„æŸ¥è¯¢, å¹¶ä¸”å¯ä»¥åŒ…å«æ¥è‡ªåµŒå…¥å¼æ–‡æ¡£å’Œæ•°ç»„çš„é”® (æ–‡æœ¬ç´¢å¼•è§£å†³æœç´¢çš„éœ€æ±‚, TTL ç´¢å¼•è§£å†³å†å²æ•°æ®è‡ªåŠ¨è¿‡æœŸçš„éœ€æ±‚, åœ°ç†ä½ç½®ç´¢å¼•å¯ä»¥ç”¨äºæ„ä»¶å„ç§ O2O åº”ç”¨)
- mmapv1, wiredtiger, mongorocks (rocksdb) in-memory ç­‰å¤šå¼•æ“æ”¯æŒæ»¡è¶³å„ç§åœºæ™¯éœ€æ±‚
- Gridfs è§£å†³æ–‡ä»¶å­˜å‚¨éœ€æ±‚

#### 1.4.2 é«˜å¯ç”¨

MongoDB çš„å¤åˆ¶å·¥å…·ç§°ä½œ**å‰¯æœ¬é›†** (replica set) å¯ä»¥æä¾›è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œæ•°æ®å†—ä½™

#### 1.4.3 é«˜æ‰©å±•

æ°´å¹³æ‰©å±•æ˜¯å…¶æ ¸å¿ƒåŠŸèƒ½ä¸€éƒ¨åˆ†

åˆ†ç‰‡å°†æ•°æ®åˆ†å¸ƒåœ¨ä¸€ç»„é›†ç¾¤çš„æœºå™¨ä¸Š (æµ·é‡æ•°æ®å­˜å‚¨, æœåŠ¡èƒ½åŠ›æ°´å¹³æ‰©å±•)

MongoDB æ”¯æŒåŸºäº**ç‰‡é”®**åˆ›å»ºæ•°æ®åŒºåŸŸ, åœ¨ä¸€ä¸ªå¹³è¡¡çš„é›†ç¾¤å½“ä¸­, MongoDB å°†ä¸€ä¸ªåŒºåŸŸæ‰€è¦†ç›–çš„è¯»å†™**åªå®šå‘**åˆ°è¯¥åŒºåŸŸçš„é‚£äº›ç‰‡

#### 1.4.4 å…¶ä»–

MongoDBæ”¯æŒä¸°å¯Œçš„æŸ¥è¯¢è¯­è¨€, æ”¯æŒè¯»å’Œå†™æ“ä½œ(CRUD), æ¯”å¦‚æ•°æ®èšåˆ, æ–‡æœ¬æœç´¢å’Œåœ°ç†ç©ºé—´æŸ¥è¯¢ç­‰. æ— æ¨¡å¼ï¼ˆåŠ¨æ€æ¨¡å¼ï¼‰, çµæ´»çš„æ–‡æ¡£æ¨¡å‹

## 2. åŸºæœ¬å¸¸ç”¨å‘½ä»¤

### 2.1 æ•°æ®åº“æ“ä½œ

é»˜è®¤ä¿ç•™çš„æ•°æ®åº“

- **admin**: ä»æƒé™è§’åº¦è€ƒè™‘, è¿™æ˜¯ `root` æ•°æ®åº“, å¦‚æœå°†ä¸€ä¸ªç”¨æˆ·æ·»åŠ åˆ°è¿™ä¸ªæ•°æ®åº“, è¿™ä¸ªç”¨æˆ·è‡ªåŠ¨ç»§æ‰¿æ‰€æœ‰æ•°æ®åº“çš„æƒé™, ä¸€äº›ç‰¹å®šçš„æœåŠ¡å™¨ç«¯å‘½ä»¤ä¹Ÿåªèƒ½ä»è¿™ä¸ªæ•°æ®åº“è¿è¡Œ, æ¯”å¦‚åˆ—å‡ºæ‰€æœ‰çš„æ•°æ®åº“æˆ–è€…å…³é—­æœåŠ¡å™¨
- **local**: æ•°æ®æ°¸è¿œä¸ä¼šè¢«å¤åˆ¶, å¯ä»¥ç”¨æ¥å­˜å‚¨é™äºæœ¬åœ°çš„å•å°æœåŠ¡å™¨çš„é›†åˆ (éƒ¨ç½²é›†ç¾¤, åˆ†ç‰‡ç­‰)
- **config**: Mongo ç”¨äºåˆ†ç‰‡è®¾ç½®æ—¶, `config` æ•°æ®åº“åœ¨å†…éƒ¨ä½¿ç”¨, ç”¨æ¥ä¿å­˜åˆ†ç‰‡çš„ç›¸å…³ä¿¡æ¯

> ```
> $ show dbs
> 
> 
> $ use articledb
> 
> $ show dbs
> ```
>
> å½“ä½¿ç”¨ `use articledb` çš„æ—¶å€™. `articledb` å…¶å®å­˜æ”¾åœ¨å†…å­˜ä¹‹ä¸­, å½“ `articledb` ä¸­å­˜åœ¨ä¸€ä¸ª collection ä¹‹å, mongo æ‰ä¼šå°†è¿™ä¸ªæ•°æ®åº“æŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¹‹ä¸­.

### 2.2 æ–‡æ¡£åŸºæœ¬ CRUD

> å®˜æ–¹æ–‡æ¡£: https://docs.mongodb.com/manual/crud/

#### 2.2.1 åˆ›å»º Create

> Create or insert operations add new [documents](https://docs.mongodb.com/manual/core/document/#bson-document-format) to a [collection](https://docs.mongodb.com/manual/core/databases-and-collections/#collections). If the collection does **not** currently exist, insert operations will create the collection automatically.

- ä½¿ç”¨ `db.<collection_name>.insertOne()` å‘é›†åˆä¸­æ·»åŠ *ä¸€ä¸ªæ–‡æ¡£*, å‚æ•°ä¸€ä¸ª json æ ¼å¼çš„æ–‡æ¡£
- ä½¿ç”¨ `db.<collection_name>.insertMany()` å‘é›†åˆä¸­æ·»åŠ *å¤šä¸ªæ–‡æ¡£*, å‚æ•°ä¸º json æ–‡æ¡£æ•°ç»„

![img](https://docs.mongodb.com/manual/_images/crud-annotated-mongodb-insertOne.bakedsvg.svg)

```
db.collection.insert({
  <document or array of documents>,
  writeConcern: <document>,
  ordered: <boolean>
})


// å‘é›†åˆä¸­æ·»åŠ ä¸€ä¸ªæ–‡æ¡£
db.collection.insertOne(
   { item: "canvas", qty: 100, tags: ["cotton"], size: { h: 28, w: 35.5, uom: "cm" } }
)
// å‘é›†åˆä¸­æ·»åŠ å¤šä¸ªæ–‡æ¡£
db.collection.insertMany([
   { item: "journal", qty: 25, tags: ["blank", "red"], size: { h: 14, w: 21, uom: "cm" } },
   { item: "mat", qty: 85, tags: ["gray"], size: { h: 27.9, w: 35.5, uom: "cm" } },
   { item: "mousepad", qty: 25, tags: ["gel", "blue"], size: { h: 19, w: 22.85, uom: "cm" } }
])
```

æ³¨ï¼šå½“æˆ‘ä»¬å‘ `collection` ä¸­æ’å…¥ `document` æ–‡æ¡£æ—¶, å¦‚æœæ²¡æœ‰ç»™æ–‡æ¡£æŒ‡å®š `_id` å±æ€§, é‚£ä¹ˆæ•°æ®åº“ä¼šä¸ºæ–‡æ¡£è‡ªåŠ¨æ·»åŠ  `_id` field, å¹¶ä¸”å€¼ç±»å‹æ˜¯ `ObjectId(blablabla)`, å°±æ˜¯æ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†, ç±»ä¼¼äº relational database é‡Œçš„ `primary key`

> - mongo ä¸­çš„æ•°å­—, é»˜è®¤æƒ…å†µä¸‹æ˜¯ double ç±»å‹, å¦‚æœè¦å­˜æ•´å‹, å¿…é¡»ä½¿ç”¨å‡½æ•° `NumberInt(æ•´å‹æ•°å­—)`, å¦åˆ™å–å‡ºæ¥å°±æœ‰é—®é¢˜äº†
> - æ’å…¥å½“å‰æ—¥æœŸå¯ä»¥ä½¿ç”¨ `new Date()`

å¦‚æœæŸæ¡æ•°æ®æ’å…¥å¤±è´¥, å°†ä¼šç»ˆæ­¢æ’å…¥, ä½†å·²ç»æ’å…¥æˆåŠŸçš„æ•°æ®**ä¸ä¼šå›æ»šæ‰**. å› ä¸ºæ‰¹é‡æ’å…¥ç”±äºæ•°æ®è¾ƒå¤šå®¹æ˜“å‡ºç°å¤±è´¥, å› æ­¤, å¯ä»¥ä½¿ç”¨ `try catch` è¿›è¡Œå¼‚å¸¸æ•æ‰å¤„ç†, æµ‹è¯•çš„æ—¶å€™å¯ä»¥ä¸å¤„ç†.å¦‚ï¼š

```
try {
  db.comment.insertMany([
    {"_id":"1","articleid":"100001","content":"æˆ‘ä»¬ä¸åº”è¯¥æŠŠæ¸…æ™¨æµªè´¹åœ¨æ‰‹æœºä¸Š, å¥åº·å¾ˆé‡è¦, ä¸€æ¯æ¸©æ°´å¹¸ç¦ä½ æˆ‘ ä»–.","userid":"1002","nickname":"ç›¸å¿˜äºæ±Ÿæ¹–","createdatetime":new Date("2019-0805T22:08:15.522Z"),"likenum":NumberInt(1000),"state":"1"},
    {"_id":"2","articleid":"100001","content":"æˆ‘å¤å¤©ç©ºè…¹å–å‡‰å¼€æ°´, å†¬å¤©å–æ¸©å¼€æ°´","userid":"1005","nickname":"ä¼Šäººæ†” æ‚´","createdatetime":new Date("2019-08-05T23:58:51.485Z"),"likenum":NumberInt(888),"state":"1"},
    {"_id":"3","articleid":"100001","content":"æˆ‘ä¸€ç›´å–å‡‰å¼€æ°´, å†¬å¤©å¤å¤©éƒ½å–.","userid":"1004","nickname":"æ°å…‹èˆ¹ é•¿","createdatetime":new Date("2019-08-06T01:05:06.321Z"),"likenum":NumberInt(666),"state":"1"},
    {"_id":"4","articleid":"100001","content":"ä¸“å®¶è¯´ä¸èƒ½ç©ºè…¹åƒé¥­, å½±å“å¥åº·.","userid":"1003","nickname":"å‡¯ æ’’","createdatetime":new Date("2019-08-06T08:18:35.288Z"),"likenum":NumberInt(2000),"state":"1"},
    {"_id":"5","articleid":"100001","content":"ç ”ç©¶è¡¨æ˜, åˆšçƒ§å¼€çš„æ°´åƒä¸‡ä¸èƒ½å–, å› ä¸ºçƒ« å˜´.","userid":"1003","nickname":"å‡¯æ’’","createdatetime":new Date("2019-0806T11:01:02.521Z"),"likenum":NumberInt(3000),"state":"1"}

]);

} catch (e) {
  print (e);
}
```

#### 2.2.2 æŸ¥è¯¢ Read

- ä½¿ç”¨ `db.<collection_name>.find()` æ–¹æ³•å¯¹é›†åˆè¿›è¡ŒæŸ¥è¯¢, æ¥å—ä¸€ä¸ª json æ ¼å¼çš„æŸ¥è¯¢æ¡ä»¶. è¿”å›çš„æ˜¯ä¸€ä¸ª**æ•°ç»„**
- `db.<collection_name>.findOne()` æŸ¥è¯¢é›†åˆä¸­ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€ä¸ªæ–‡æ¡£, è¿”å›çš„æ˜¯ä¸€ä¸ª**å¯¹è±¡**

![img](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/crud-annotated-mongodb-find.bakedsvg.png)

å¯ä»¥ä½¿ç”¨ `$in` æ“ä½œç¬¦è¡¨ç¤º*èŒƒå›´æŸ¥è¯¢*

```
db.inventory.find( { status: { $in: [ "A", "D" ] } } )
```

å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ç”¨é€—å·åˆ†éš”, è¡¨ç¤º `AND` çš„å…³ç³»

```
db.inventory.find( { status: "A", qty: { $lt: 30 } } )
```

ç­‰ä»·äºä¸‹é¢ sql è¯­å¥

```mysql
SELECT * FROM inventory WHERE status = "A" AND qty < 30
```

ä½¿ç”¨ `$or` æ“ä½œç¬¦è¡¨ç¤ºåè¾¹æ•°ç»„ä¸­çš„æ¡ä»¶æ˜¯ORçš„å…³ç³»

```
db.inventory.find( { $or: [ { status: "A" }, { qty: { $lt: 30 } } ] } )
```

ç­‰ä»·äºä¸‹é¢ sql è¯­å¥

```mysql
SELECT * FROM inventory WHERE status = "A" OR qty < 30
```

è”åˆä½¿ç”¨ `AND` å’Œ `OR` çš„æŸ¥è¯¢è¯­å¥

```
db.inventory.find( {
     status: "A",
     $or: [ { qty: { $lt: 30 } }, { item: /^p/ } ]
} )
```

åœ¨ terminal ä¸­æŸ¥çœ‹ç»“æœå¯èƒ½ä¸æ˜¯å¾ˆæ–¹ä¾¿, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ `pretty()` æ¥å¸®åŠ©é˜…è¯»

```
db.inventory.find().pretty()
```

åŒ¹é…å†…å®¹

```
db.posts.find({
  comments: {
    $elemMatch: {
      user: 'Harry Potter'
    }
  }
}).pretty()

// æ­£åˆ™è¡¨è¾¾å¼
db.<collection_name>.find({ content : /once/ })
```

åˆ›å»ºç´¢å¼•

```
db.posts.createIndex({
  { title : 'text' }
})

// æ–‡æœ¬æœç´¢
// will return document with title "Post One"
// if there is no more posts created
db.posts.find({
  $text : {
    $search : "\"Post O\""
  }
}).pretty()
```

#### 2.2.3 æ›´æ–° Update

- ä½¿ç”¨ `db.<collection_name>.updateOne(<filter>, <update>, <options>)` æ–¹æ³•ä¿®æ”¹ä¸€ä¸ªåŒ¹é… `<filter>` æ¡ä»¶çš„æ–‡æ¡£
- ä½¿ç”¨ `db.<collection_name>.updateMany(<filter>, <update>, <options>)` æ–¹æ³•ä¿®æ”¹æ‰€æœ‰åŒ¹é… `<filter>` æ¡ä»¶çš„æ–‡æ¡£
- ä½¿ç”¨ `db.<collection_name>.replaceOne(<filter>, <update>, <options>)` æ–¹æ³•**æ›¿æ¢**ä¸€ä¸ªåŒ¹é… `<filter>` æ¡ä»¶çš„æ–‡æ¡£
- `db.<collection_name>.update(æŸ¥è¯¢å¯¹è±¡, æ–°å¯¹è±¡)` é»˜è®¤æƒ…å†µä¸‹ä¼šä½¿ç”¨æ–°å¯¹è±¡æ›¿æ¢æ—§å¯¹è±¡

å…¶ä¸­ `<filter>` å‚æ•°ä¸æŸ¥è¯¢æ–¹æ³•ä¸­çš„æ¡ä»¶å‚æ•°ç”¨æ³•ä¸€è‡´.

å¦‚æœéœ€è¦ä¿®æ”¹æŒ‡å®šçš„å±æ€§, è€Œä¸æ˜¯æ›¿æ¢éœ€è¦ç”¨â€œä¿®æ”¹æ“ä½œç¬¦â€æ¥è¿›è¡Œä¿®æ”¹

- `$set` ä¿®æ”¹æ–‡æ¡£ä¸­çš„åˆ¶å®šå±æ€§

å…¶ä¸­æœ€å¸¸ç”¨çš„ä¿®æ”¹æ“ä½œç¬¦å³ä¸º`$set`å’Œ`$unset`,åˆ†åˆ«è¡¨ç¤º**èµ‹å€¼**å’Œ**å–æ¶ˆèµ‹å€¼**.

```
db.inventory.updateOne(
    { item: "paper" },
    {
        $set: { "size.uom": "cm", status: "P" },
        $currentDate: { lastModified: true }
    }
)

db.inventory.updateMany(
    { qty: { $lt: 50 } },
    {
        $set: { "size.uom": "in", status: "P" },
        $currentDate: { lastModified: true }
    }
)
```

> - uses the [`$set`](https://docs.mongodb.com/manual/reference/operator/update/set/#up._S_set) operator to update the value of the `size.uom` field to `"cm"` and the value of the `status` field to `"P"`,
> - uses the [`$currentDate`](https://docs.mongodb.com/manual/reference/operator/update/currentDate/#up._S_currentDate) operator to update the value of the `lastModified` field to the current date. If `lastModified` field does not exist, [`$currentDate`](https://docs.mongodb.com/manual/reference/operator/update/currentDate/#up._S_currentDate) will create the field. See [`$currentDate`](https://docs.mongodb.com/manual/reference/operator/update/currentDate/#up._S_currentDate) for details.

`db.<collection_name>.replaceOne()` æ–¹æ³•æ›¿æ¢é™¤ `_id` å±æ€§å¤–çš„**æ‰€æœ‰å±æ€§**, å…¶`<update>`å‚æ•°åº”ä¸ºä¸€ä¸ª**å…¨æ–°çš„æ–‡æ¡£**.

```
db.inventory.replaceOne(
    { item: "paper" },
    { item: "paper", instock: [ { warehouse: "A", qty: 60 }, { warehouse: "B", qty: 40 } ] }
)
```

**æ‰¹é‡ä¿®æ”¹**

```
// é»˜è®¤ä¼šä¿®æ”¹ç¬¬ä¸€æ¡
db.document.update({ userid: "30", { $set {username: "guest"} } })

// ä¿®æ”¹æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®
db.document.update( { userid: "30", { $set {username: "guest"} } }, {multi: true} )
```

**åˆ—å€¼å¢é•¿çš„ä¿®æ”¹**

å¦‚æœæˆ‘ä»¬æƒ³å®ç°å¯¹æŸåˆ—å€¼åœ¨åŸæœ‰å€¼çš„åŸºç¡€ä¸Šè¿›è¡Œå¢åŠ æˆ–å‡å°‘, å¯ä»¥ä½¿ç”¨ `$inc` è¿ç®—ç¬¦æ¥å®ç°

```
db.document.update({ _id: "3", {$inc: {likeNum: NumberInt(1)}} })
```

##### ä¿®æ”¹æ“ä½œç¬¦

| Name                                                         | Description                                                  |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`$currentDate`](https://docs.mongodb.com/manual/reference/operator/update/currentDate/#up._S_currentDate) | Sets the value of a field to current date, either as a Date or a Timestamp. |
| [`$inc`](https://docs.mongodb.com/manual/reference/operator/update/inc/#up._S_inc) | Increments the value of the field by the specified amount.   |
| [`$min`](https://docs.mongodb.com/manual/reference/operator/update/min/#up._S_min) | Only updates the field if the specified value is less than the existing field value. |
| [`$max`](https://docs.mongodb.com/manual/reference/operator/update/max/#up._S_max) | Only updates the field if the specified value is greater than the existing field value. |
| [`$mul`](https://docs.mongodb.com/manual/reference/operator/update/mul/#up._S_mul) | Multiplies the value of the field by the specified amount.   |
| [`$rename`](https://docs.mongodb.com/manual/reference/operator/update/rename/#up._S_rename) | Renames a field.                                             |
| [`$set`](https://docs.mongodb.com/manual/reference/operator/update/set/#up._S_set) | Sets the value of a field in a document.                     |
| [`$setOnInsert`](https://docs.mongodb.com/manual/reference/operator/update/setOnInsert/#up._S_setOnInsert) | Sets the value of a field if an update results in an insert of a document. Has no effect on update operations that modify existing documents. |
| [`$unset`](https://docs.mongodb.com/manual/reference/operator/update/unset/#up._S_unset) | Removes the specified field from a document.                 |

#### 2.2.4 åˆ é™¤ Delete

- ä½¿ç”¨ `db.collection.deleteMany()` æ–¹æ³•åˆ é™¤æ‰€æœ‰åŒ¹é…çš„æ–‡æ¡£.
- ä½¿ç”¨ `db.collection.deleteOne()` æ–¹æ³•åˆ é™¤å•ä¸ªåŒ¹é…çš„æ–‡æ¡£.
- `db.collection.drop()`
- `db.dropDatabase()`

```
db.inventory.deleteMany( { qty : { $lt : 50 } } )
```

> Delete operations **do not drop indexes**, even if deleting all documents from a collection.
>
> ä¸€èˆ¬æ•°æ®åº“ä¸­çš„æ•°æ®éƒ½ä¸ä¼šçœŸæ­£æ„ä¹‰ä¸Šçš„åˆ é™¤, ä¼šæ·»åŠ ä¸€ä¸ªå­—æ®µ, ç”¨æ¥è¡¨ç¤ºè¿™ä¸ªæ•°æ®æ˜¯å¦è¢«åˆ é™¤

### 2.3 æ–‡æ¡£æ’åºå’ŒæŠ•å½± (sort & projection)

#### 2.3.1 æ’åº Sort

åœ¨æŸ¥è¯¢æ–‡æ¡£å†…å®¹çš„æ—¶å€™, é»˜è®¤æ˜¯æŒ‰ç…§ `_id` è¿›è¡Œæ’åº

æˆ‘ä»¬å¯ä»¥ç”¨ `$sort` æ›´æ”¹æ–‡æ¡£æ’åºè§„åˆ™

```
{ $sort: { <field1>: <sort order>, <field2>: <sort order> ... } }
```

For the field or fields to sort by, set the sort order to `1` or `-1` to specify an *ascending* or *descending* sort respectively, as in the following example:

```
db.users.aggregate(
   [
     { $sort : { age : -1, posts: 1 } }
     // ascending on posts and descending on age
   ]
)
```

##### `$sort` Operator and Memory

##### `$sort` + `$limit` Memory Optimization

When a [`$sort`](https://docs.mongodb.com/manual/reference/operator/aggregation/sort/index.html#pipe._S_sort) precedes a [`$limit`](https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit) and there are no intervening stages that modify the number of documents, the optimizer can coalesce the [`$limit`](https://docs.mongodb.com/manual/reference/operator/aggregation/limit/#pipe._S_limit) into the [`$sort`](https://docs.mongodb.com/manual/reference/operator/aggregation/sort/index.html#pipe._S_sort). This allows the [`$sort`](https://docs.mongodb.com/manual/reference/operator/aggregation/sort/index.html#pipe._S_sort) operation to **only maintain the top `n` results as it progresses**, where `n` is the specified limit, and ensures that MongoDB only needs to store `n` items in memory. This optimization still applies when `allowDiskUse` is `true` and the `n` items exceed the [aggregation memory limit](https://docs.mongodb.com/manual/core/aggregation-pipeline-limits/#agg-memory-restrictions).

Optimizations are subject to change between releases.

> æœ‰ç‚¹ç±»ä¼¼äºç”¨ heap åš topK è¿™ç§é—®é¢˜, åªç»´æŠ¤ k ä¸ªå¤§å°çš„ heap, ä¼šåŠ é€Ÿ process

ä¸¾ä¸ªæ —å­:

```
db.posts.find().sort({ title : -1 }).limit(2).pretty()
```

#### 2.3.2 æŠ•å½± Projection

æœ‰äº›æƒ…å†µ, æˆ‘ä»¬å¯¹æ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢å¹¶ä¸æ˜¯éœ€è¦æ‰€æœ‰çš„å­—æ®µ, æ¯”å¦‚åªéœ€è¦ id æˆ–è€… ç”¨æˆ·å, æˆ‘ä»¬å¯ä»¥å¯¹æ–‡æ¡£è¿›è¡Œâ€œæŠ•å½±â€

- `1` - display
- `0` - dont display

```
> db.users.find( {}, {username: 1} )

> db.users.find( {}, {age: 1, _id: 0} )
```

### 2.4 forEach()

```
> db.posts.find().forEach(fucntion(doc) { print('Blog Post: ' + doc.title) })
```

### 2.5 å…¶ä»–æŸ¥è¯¢æ–¹å¼

#### 2.5.1 æ­£åˆ™è¡¨è¾¾å¼

```
$ db.collection.find({field:/æ­£åˆ™è¡¨è¾¾å¼/})

$ db.collection.find({å­—æ®µ:/æ­£åˆ™è¡¨è¾¾å¼/})
```

#### 2.5.2 æ¯”è¾ƒæŸ¥è¯¢

`<`, `<=`, `>`, `>=` è¿™äº›æ“ä½œç¬¦ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„, æ ¼å¼å¦‚ä¸‹:

```
db.collection.find({ "field" : { $gt: value }}) // å¤§äº: field > value
db.collection.find({ "field" : { $lt: value }}) // å°äº: field < value
db.collection.find({ "field" : { $gte: value }}) // å¤§äºç­‰äº: field >= value
db.collection.find({ "field" : { $lte: value }}) // å°äºç­‰äº: field <= value
db.collection.find({ "field" : { $ne: value }}) // ä¸ç­‰äº: field != value
```

#### 2.5.3 åŒ…å«æŸ¥è¯¢

åŒ…å«ä½¿ç”¨ `$in` æ“ä½œç¬¦. ç¤ºä¾‹ï¼šæŸ¥è¯¢è¯„è®ºçš„é›†åˆä¸­ `userid` å­—æ®µåŒ…å« `1003` æˆ– `1004`çš„æ–‡æ¡£

```
db.comment.find({userid:{$in:["1003","1004"]}})
```

ä¸åŒ…å«ä½¿ç”¨ `$nin` æ“ä½œç¬¦. ç¤ºä¾‹ï¼šæŸ¥è¯¢è¯„è®ºé›†åˆä¸­ `userid` å­—æ®µä¸åŒ…å« `1003` å’Œ `1004` çš„æ–‡æ¡£

```
db.comment.find({userid:{$nin:["1003","1004"]}})
```

## 2.6 å¸¸ç”¨å‘½ä»¤å°ç»“

```
é€‰æ‹©åˆ‡æ¢æ•°æ®åº“ï¼šuse articledb
æ’å…¥æ•°æ®ï¼šdb.comment.insert({bsonæ•°æ®})
æŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼šdb.comment.find();
æ¡ä»¶æŸ¥è¯¢æ•°æ®ï¼šdb.comment.find({æ¡ä»¶})
æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•ï¼šdb.comment.findOne({æ¡ä»¶})
æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„å‰å‡ æ¡è®°å½•ï¼šdb.comment.find({æ¡ä»¶}).limit(æ¡æ•°)
æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„è·³è¿‡çš„è®°å½•ï¼šdb.comment.find({æ¡ä»¶}).skip(æ¡æ•°)

ä¿®æ”¹æ•°æ®ï¼šdb.comment.update({æ¡ä»¶},{ä¿®æ”¹åçš„æ•°æ®})
        æˆ–
        db.comment.update({æ¡ä»¶},{$set:{è¦ä¿®æ”¹éƒ¨åˆ†çš„å­—æ®µ:æ•°æ®})

ä¿®æ”¹æ•°æ®å¹¶è‡ªå¢æŸå­—æ®µå€¼ï¼šdb.comment.update({æ¡ä»¶},{$inc:{è‡ªå¢çš„å­—æ®µ:æ­¥è¿›å€¼}})

åˆ é™¤æ•°æ®ï¼šdb.comment.remove({æ¡ä»¶})
ç»Ÿè®¡æŸ¥è¯¢ï¼šdb.comment.count({æ¡ä»¶})
æ¨¡ç³ŠæŸ¥è¯¢ï¼šdb.comment.find({å­—æ®µå:/æ­£åˆ™è¡¨è¾¾å¼/})
æ¡ä»¶æ¯”è¾ƒè¿ç®—ï¼šdb.comment.find({å­—æ®µå:{$gt:å€¼}})
åŒ…å«æŸ¥è¯¢ï¼šdb.comment.find({å­—æ®µå:{$in:[å€¼1, å€¼2]}})
        æˆ–
        db.comment.find({å­—æ®µå:{$nin:[å€¼1, å€¼2]}})

æ¡ä»¶è¿æ¥æŸ¥è¯¢ï¼šdb.comment.find({$and:[{æ¡ä»¶1},{æ¡ä»¶2}]})
           æˆ–
           db.comment.find({$or:[{æ¡ä»¶1},{æ¡ä»¶2}]})
```

## 3. æ–‡æ¡£é—´çš„å¯¹åº”å…³ç³»

- ä¸€å¯¹ä¸€ (One To One)
- ä¸€å¯¹å¤š (One To Many)
- å¤šå¯¹å¤š (Many To Many)

ä¸¾ä¸ªä¾‹å­, æ¯”å¦‚â€œç”¨æˆ·-è®¢å•â€è¿™ä¸ªä¸€å¯¹å¤šçš„å…³ç³»ä¸­, æˆ‘ä»¬æƒ³æŸ¥è¯¢æŸä¸€ä¸ªç”¨æˆ·çš„æ‰€æœ‰æˆ–è€…æŸä¸ªè®¢å•, æˆ‘ä»¬å¯ä»¥

```
var user_id = db.users.findOne( {username: "username_here"} )._id
db.orders.find( {user_id: user_id} )
```

## 4. MongoDB çš„ç´¢å¼•

### 4.1 æ¦‚è¿°

ç´¢å¼•æ”¯æŒåœ¨ MongoDB ä¸­é«˜æ•ˆåœ°æ‰§è¡ŒæŸ¥è¯¢.å¦‚æœæ²¡æœ‰ç´¢å¼•, MongoDB å¿…é¡»æ‰§è¡Œå…¨é›†åˆæ‰«æ, å³æ‰«æé›†åˆä¸­çš„æ¯ä¸ªæ–‡æ¡£, ä»¥é€‰æ‹©ä¸æŸ¥è¯¢è¯­å¥ åŒ¹é…çš„æ–‡æ¡£.è¿™ç§æ‰«æå…¨é›†åˆçš„æŸ¥è¯¢æ•ˆç‡æ˜¯éå¸¸ä½çš„, ç‰¹åˆ«åœ¨å¤„ç†å¤§é‡çš„æ•°æ®æ—¶, æŸ¥è¯¢å¯ä»¥è¦èŠ±è´¹å‡ åç§’ç”šè‡³å‡ åˆ†é’Ÿ, è¿™å¯¹ç½‘ç«™çš„æ€§èƒ½æ˜¯éå¸¸è‡´å‘½çš„.

å¦‚æœæŸ¥è¯¢å­˜åœ¨é€‚å½“çš„ç´¢å¼•, MongoDB å¯ä»¥ä½¿ç”¨è¯¥ç´¢å¼•é™åˆ¶å¿…é¡»æ£€æŸ¥çš„æ–‡æ¡£æ•°.

ç´¢å¼•æ˜¯ç‰¹æ®Šçš„æ•°æ®ç»“æ„, å®ƒä»¥æ˜“äºéå†çš„å½¢å¼å­˜å‚¨é›†åˆæ•°æ®é›†çš„ä¸€å°éƒ¨åˆ†.ç´¢å¼•å­˜å‚¨ç‰¹å®šå­—æ®µæˆ–ä¸€ç»„å­—æ®µçš„å€¼, æŒ‰å­—æ®µå€¼æ’åº.ç´¢å¼•é¡¹çš„æ’ åºæ”¯æŒæœ‰æ•ˆçš„ç›¸ç­‰åŒ¹é…å’ŒåŸºäºèŒƒå›´çš„æŸ¥è¯¢æ“ä½œ.æ­¤å¤–, MongoDB è¿˜å¯ä»¥ä½¿ç”¨ç´¢å¼•ä¸­çš„æ’åºè¿”å›æ’åºç»“æœ.

MongoDB ä½¿ç”¨çš„æ˜¯ B Tree, MySQL ä½¿ç”¨çš„æ˜¯ B+ Tree

```
// create index
db.<collection_name>.createIndex({ userid : 1, username : -1 })

// retrieve indexes
db.<collection_name>.getIndexes()

// remove indexes
db.<collection_name>.dropIndex(index)

// there are 2 ways to remove indexes:
// 1. removed based on the index name
// 2. removed based on the fields

db.<collection_name>.dropIndex( "userid_1_username_-1" )
db.<collection_name>.dropIndex({ userid : 1, username : -1 })

// remove all the indexes, will only remove non_id indexes
db.<collection_name>.dropIndexes()
```

### 4.2 ç´¢å¼•çš„ç±»å‹

#### 4.2.1 å•å­—æ®µç´¢å¼•

MongoDB æ”¯æŒåœ¨æ–‡æ¡£çš„å•ä¸ªå­—æ®µä¸Šåˆ›å»ºç”¨æˆ·å®šä¹‰çš„**å‡åº/é™åºç´¢å¼•**, ç§°ä¸º**å•å­—æ®µç´¢å¼•** Single Field Index

å¯¹äºå•ä¸ªå­—æ®µç´¢å¼•å’Œæ’åºæ“ä½œ, ç´¢å¼•é”®çš„æ’åºé¡ºåºï¼ˆå³å‡åºæˆ–é™åºï¼‰å¹¶ä¸é‡è¦, å› ä¸º MongoDB å¯ä»¥åœ¨ä»»ä½•æ–¹å‘ä¸Šéå†ç´¢å¼•.

![img](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/image-20200505231043779.png)

#### 4.2.2 å¤åˆç´¢å¼•

MongoDB è¿˜æ”¯æŒå¤šä¸ªå­—æ®µçš„ç”¨æˆ·å®šä¹‰ç´¢å¼•, å³å¤åˆç´¢å¼• Compound Index

å¤åˆç´¢å¼•ä¸­åˆ—å‡ºçš„å­—æ®µé¡ºåºå…·æœ‰é‡è¦æ„ä¹‰.ä¾‹å¦‚, å¦‚æœå¤åˆç´¢å¼•ç”± `{ userid: 1, score: -1 }` ç»„æˆ, åˆ™ç´¢å¼•é¦–å…ˆæŒ‰ `userid` æ­£åºæ’åº, ç„¶å åœ¨æ¯ä¸ª `userid` çš„å€¼å†…, å†åœ¨æŒ‰ `score` å€’åºæ’åº.

![img](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/image-20200505231305941.png)

#### 4.2.3 å…¶ä»–ç´¢å¼•

- åœ°ç†ç©ºé—´ç´¢å¼• Geospatial Index
- æ–‡æœ¬ç´¢å¼• Text Indexes
- å“ˆå¸Œç´¢å¼• Hashed Indexes

##### åœ°ç†ç©ºé—´ç´¢å¼•ï¼ˆGeospatial Indexï¼‰

ä¸ºäº†æ”¯æŒå¯¹åœ°ç†ç©ºé—´åæ ‡æ•°æ®çš„æœ‰æ•ˆæŸ¥è¯¢, MongoDB æä¾›äº†ä¸¤ç§ç‰¹æ®Šçš„ç´¢å¼•: è¿”å›ç»“æœæ—¶ä½¿ç”¨å¹³é¢å‡ ä½•çš„äºŒç»´ç´¢å¼•å’Œè¿”å›ç»“æœæ—¶ä½¿ç”¨çƒé¢å‡ ä½•çš„äºŒç»´çƒé¢ç´¢å¼•.

##### æ–‡æœ¬ç´¢å¼•ï¼ˆText Indexesï¼‰

MongoDB æä¾›äº†ä¸€ç§æ–‡æœ¬ç´¢å¼•ç±»å‹, æ”¯æŒåœ¨é›†åˆä¸­æœç´¢å­—ç¬¦ä¸²å†…å®¹.è¿™äº›æ–‡æœ¬ç´¢å¼•ä¸å­˜å‚¨ç‰¹å®šäºè¯­è¨€çš„åœæ­¢è¯ï¼ˆä¾‹å¦‚ â€œtheâ€, â€œaâ€, â€œorâ€ï¼‰, è€Œå°†é›†åˆä¸­çš„è¯ä½œä¸ºè¯å¹², åªå­˜å‚¨æ ¹è¯.

##### å“ˆå¸Œç´¢å¼•ï¼ˆHashed Indexesï¼‰

ä¸ºäº†æ”¯æŒåŸºäºæ•£åˆ—çš„åˆ†ç‰‡, MongoDB æä¾›äº†æ•£åˆ—ç´¢å¼•ç±»å‹, å®ƒå¯¹å­—æ®µå€¼çš„æ•£åˆ—è¿›è¡Œç´¢å¼•.è¿™äº›ç´¢å¼•åœ¨å…¶èŒƒå›´å†…çš„å€¼åˆ†å¸ƒæ›´åŠ éšæœº, ä½†åªæ”¯æŒç›¸ç­‰åŒ¹é…, ä¸æ”¯æŒåŸºäºèŒƒå›´çš„æŸ¥è¯¢.

### 4.3 ç´¢å¼•çš„ç®¡ç†æ“ä½œ

#### 4.3.1 ç´¢å¼•çš„æŸ¥çœ‹

è¯­æ³•

```
db.collection.getIndexes()
```

é»˜è®¤ `_id` ç´¢å¼•ï¼š MongoDB åœ¨åˆ›å»ºé›†åˆçš„è¿‡ç¨‹ä¸­, åœ¨ `_id` å­—æ®µä¸Šåˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ç´¢å¼•, é»˜è®¤åå­—ä¸º `_id` , è¯¥ç´¢å¼•å¯é˜²æ­¢å®¢æˆ·ç«¯æ’å…¥ä¸¤ä¸ªå…·æœ‰ç›¸åŒå€¼çš„æ–‡ æ¡£, ä¸èƒ½åœ¨ `_id` å­—æ®µä¸Šåˆ é™¤æ­¤ç´¢å¼•.

æ³¨æ„ï¼šè¯¥ç´¢å¼•æ˜¯**å”¯ä¸€ç´¢å¼•**, å› æ­¤å€¼ä¸èƒ½é‡å¤, å³ `_id` å€¼ä¸èƒ½é‡å¤çš„.

åœ¨åˆ†ç‰‡é›†ç¾¤ä¸­, é€šå¸¸ä½¿ç”¨ `_id` ä½œä¸º**ç‰‡é”®**.

#### 4.3.2 ç´¢å¼•çš„åˆ›å»º

è¯­æ³•

```
db.collection.createIndex(keys, options)
```

å‚æ•°

![image-20200506203419523](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/image-20200506203419523.png)

optionsï¼ˆæ›´å¤šé€‰é¡¹ï¼‰åˆ—è¡¨

![image-20200506203453430](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/image-20200506203453430.png)

æ³¨æ„åœ¨ 3.0.0 ç‰ˆæœ¬å‰åˆ›å»ºç´¢å¼•æ–¹æ³•ä¸º `db.collection.ensureIndex()` , ä¹‹åçš„ç‰ˆæœ¬ä½¿ç”¨äº† `db.collection.createIndex()` æ–¹æ³•, `ensureIndex()` è¿˜èƒ½ç”¨, ä½†åªæ˜¯ `createIndex()` çš„åˆ«å.

ä¸¾ä¸ªğŸŒ°

```
$  db.comment.createIndex({userid:1})
{
  "createdCollectionAutomatically" : false,
  "numIndexesBefore" : 1,
  "numIndexesAfter" : 2,
  "ok" : 1
}

$ db.comment.createIndex({userid:1,nickname:-1})
...
```

#### 4.3.3 ç´¢å¼•çš„åˆ é™¤

è¯­æ³•

```
# åˆ é™¤æŸä¸€ä¸ªç´¢å¼•
$ db.collection.dropIndex(index)

# åˆ é™¤å…¨éƒ¨ç´¢å¼•
$ db.collection.dropIndexes()
```

æç¤º:

`_id` çš„å­—æ®µçš„ç´¢å¼•æ˜¯æ— æ³•åˆ é™¤çš„, åªèƒ½åˆ é™¤é `_id` å­—æ®µçš„ç´¢å¼•

ç¤ºä¾‹

```
# åˆ é™¤ comment é›†åˆä¸­ userid å­—æ®µä¸Šçš„å‡åºç´¢å¼•
$ db.comment.dropIndex({userid:1})
```

### 4.4 ç´¢å¼•ä½¿ç”¨

#### 4.4.1 æ‰§è¡Œè®¡åˆ’

åˆ†ææŸ¥è¯¢æ€§èƒ½ (Analyze Query Performance) é€šå¸¸ä½¿ç”¨æ‰§è¡Œè®¡åˆ’ (è§£é‡Šè®¡åˆ’ - Explain Plan) æ¥æŸ¥çœ‹æŸ¥è¯¢çš„æƒ…å†µ

```
$ db.<collection_name>.find( query, options ).explain(options)
```

æ¯”å¦‚: æŸ¥çœ‹æ ¹æ® `user_id` æŸ¥è¯¢æ•°æ®çš„æƒ…å†µ

**æœªæ·»åŠ ç´¢å¼•ä¹‹å‰**

`"stage" : "COLLSCAN"`, è¡¨ç¤ºå…¨é›†åˆæ‰«æ

![img](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/image-20200506205714154.png)

**æ·»åŠ ç´¢å¼•ä¹‹å**

`"stage" : "IXSCAN"`, åŸºäºç´¢å¼•çš„æ‰«æ

#### 4.4.2 æ¶µç›–çš„æŸ¥è¯¢

å½“æŸ¥è¯¢æ¡ä»¶å’ŒæŸ¥è¯¢çš„æŠ•å½±ä»…åŒ…å«ç´¢å¼•å­—æ®µæ˜¯, MongoDB ç›´æ¥ä»ç´¢å¼•è¿”å›ç»“æœ, è€Œä¸æ‰«æä»»ä½•æ–‡æ¡£æˆ–å°†æ–‡æ¡£å¸¦å…¥å†…å­˜, è¿™äº›è¦†ç›–çš„æŸ¥è¯¢ååˆ†æœ‰æ•ˆ

> https://docs.mongodb.com/manual/core/query-optimization/#covered-query

## 5. åœ¨ Nodejs ä¸­ä½¿ç”¨ MongoDB - mongoose

mongoose æ˜¯ä¸€ä¸ªå¯¹è±¡æ–‡æ¡£æ¨¡å‹ï¼ˆODMï¼‰åº“

> https://mongoosejs.com/

- å¯ä»¥ä¸ºæ–‡æ¡£åˆ›å»ºä¸€ä¸ªæ¨¡å¼ç»“æ„ï¼ˆSchemaï¼‰
- å¯ä»¥å¯¹æ¨¡å‹ä¸­çš„å¯¹è±¡/æ–‡æ¡£è¿›è¡ŒéªŒè¯
- æ•°æ®å¯ä»¥é€šè¿‡ç±»å‹è½¬æ¢è½¬æ¢ä¸ºå¯¹è±¡æ¨¡å‹
- å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶åº”ç”¨ä¸šåŠ¡é€»è¾‘

### 5.1 mongoose æä¾›çš„æ–°å¯¹è±¡ç±»å‹

- Schema
  - å®šä¹‰çº¦æŸäº†æ•°æ®åº“ä¸­çš„æ–‡æ¡£ç»“æ„
  - ä¸ªäººæ„Ÿè§‰ç±»ä¼¼äº SQL ä¸­å»ºè¡¨æ—¶äº‹å…ˆè§„å®šè¡¨ç»“æ„
- Model
  - é›†åˆä¸­çš„æ‰€æœ‰æ–‡æ¡£çš„è¡¨ç¤º, ç›¸å½“äº MongoDB æ•°æ®åº“ä¸­çš„ collection
- Document
  - è¡¨ç¤ºé›†åˆä¸­çš„å…·ä½“æ–‡æ¡£, ç›¸å½“äºé›†åˆä¸­çš„ä¸€ä¸ªå…·ä½“çš„æ–‡æ¡£

### 5.2 ç®€å•ä½¿ç”¨ Mongoose

> https://mongoosejs.com/docs/guide.html

ä½¿ç”¨ mongoose è¿”å›çš„æ˜¯ä¸€ä¸ª `mogoose Query object`, mongoose æ‰§è¡Œ query è¯­å¥åçš„ç»“æœä¼šè¢«ä¼ è¿› callback å‡½æ•° `callback(error, result)`

> A mongoose query can be executed in one of two ways. First, if you pass in a `callback` function, Mongoose will execute the query asynchronously and pass the results to the `callback`.
>
> A query also has a `.then()` function, and thus can be used as a promise.

```
const q = MyModel.updateMany({}, { isDeleted: true }, function() {
  console.log("Update 1");
}));

q.then(() => console.log("Update 2"));
q.then(() => console.log("Update 3"));
```

ä¸Šé¢è¿™ä¸€æ®µä»£ç ä¼šæ‰§è¡Œä¸‰æ¬¡ `updateMany()` æ“ä½œ, ç¬¬ä¸€æ¬¡æ˜¯å› ä¸º callback, ä¹‹åçš„ä¸¤æ¬¡æ˜¯å› ä¸º `.then()` (å› ä¸º `.then()` ä¹Ÿä¼šè°ƒç”¨ `updatemany()`)

**è¿æ¥æ•°æ®åº“å¹¶ä¸”åˆ›å»º Model ç±»**

```
const mongoose = require('mongoose');
// test is the name of database, will be created automatically
mongoose.connect('mongodb://localhost:27017/test', {useNewUrlParser: true});

const Cat = mongoose.model('Cat', { name: String });

const kitty = new Cat({ name: 'Zildjian' });
kitty.save().then(() => console.log('meow'));
```

**ç›‘å¬ MongoDB æ•°æ®åº“çš„è¿æ¥çŠ¶æ€**

åœ¨ mongoose å¯¹è±¡ä¸­, æœ‰ä¸€ä¸ªå±æ€§å«åš `connection`, è¯¥å¯¹è±¡å°±è¡¨ç¤ºæ•°æ®åº“è¿æ¥.é€šè¿‡ç›‘è§†è¯¥å¯¹è±¡çš„çŠ¶æ€, å¯ä»¥æ¥ç›‘å¬æ•°æ®åº“çš„è¿æ¥å’Œç«¯å£

```
mongoose.connection.once("open", function() {
  console.log("connection opened.")
});

mongoose.connection.once("close", function() {
  console.log("connection closed.")
});
```

### 5.3 Mongoose çš„ CRUD

é¦–å…ˆå®šä¹‰ä¸€ä¸ª `Schema`

```
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const blogSchema = new Schema({
    title:  String, // String is shorthand for {type: String}
    author: String,
    body:   String,
    comments: [{ body: String, date: Date }],
    date: { type: Date, default: Date.now },
    hidden: Boolean,
    meta: {
        votes: Number,
        favs:  Number
    }
});
```

ç„¶ååœ¨ `blogSchema` åŸºç¡€ä¸Šåˆ›å»º `Model`

```
const Blog = mongoose.model('Blog', blogSchema);
// ready to go!

module.exports = Blog;
```

å½“è°ƒç”¨ä¸Šé¢è¿™ä¸€è¡Œä»£ç æ—¶, MongoDB ä¼šåšå¦‚ä¸‹æ“ä½œ

1. æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ•°æ®åº“å«åš `Blog` å•Š? æ²¡çš„è¯é‚£å°±åˆ›å»ºä¸€ä¸ª
2. æ¯æ¬¡ç”¨åˆ° Blog åº“çš„æ—¶å€™éƒ½è¦æ³¨æ„å†…éƒ¨æ•°æ®è¦æŒ‰ç…§ `blogSchema` æ¥è§„å®š

å‘æ•°æ®åº“ä¸­æ’å…¥æ–‡æ¡£æ•°æ®

```
Blog.create({
  title: "title"
  ...
}, function (err){
  if (!err) {
    console.log("successful")
  }
});
```

ç®€å•çš„æŸ¥è¯¢ä¸€ä¸‹ä¸‹

```
// named john and at least 18 yo
MyModel.find({ name: 'john', age: { $gte: 18 }});
```

mongoose æ”¯æŒçš„ç”¨æ³•æœ‰:

- [`Model.deleteMany()`](https://mongoosejs.com/docs/api.html#model_Model.deleteMany)
- [`Model.deleteOne()`](https://mongoosejs.com/docs/api.html#model_Model.deleteOne)
- [`Model.find()`](https://mongoosejs.com/docs/api.html#model_Model.find)
- [`Model.findById()`](https://mongoosejs.com/docs/api.html#model_Model.findById)
- [`Model.findByIdAndDelete()`](https://mongoosejs.com/docs/api.html#model_Model.findByIdAndDelete)
- [`Model.findByIdAndRemove()`](https://mongoosejs.com/docs/api.html#model_Model.findByIdAndRemove)
- [`Model.findByIdAndUpdate()`](https://mongoosejs.com/docs/api.html#model_Model.findByIdAndUpdate)
- [`Model.findOne()`](https://mongoosejs.com/docs/api.html#model_Model.findOne)
- [`Model.findOneAndDelete()`](https://mongoosejs.com/docs/api.html#model_Model.findOneAndDelete)
- [`Model.findOneAndRemove()`](https://mongoosejs.com/docs/api.html#model_Model.findOneAndRemove)
- [`Model.findOneAndReplace()`](https://mongoosejs.com/docs/api.html#model_Model.findOneAndReplace)
- [`Model.findOneAndUpdate()`](https://mongoosejs.com/docs/api.html#model_Model.findOneAndUpdate)
- [`Model.replaceOne()`](https://mongoosejs.com/docs/api.html#model_Model.replaceOne)
- [`Model.updateMany()`](https://mongoosejs.com/docs/api.html#model_Model.updateMany)
- [`Model.updateOne()`](https://mongoosejs.com/docs/api.html#model_Model.updateOne)

## 6. ä½¿ç”¨ Mocha ç¼–å†™æµ‹è¯• â€œTest Driven Developmentâ€

Mocha æ˜¯ä¸€ä¸ª js æµ‹è¯•çš„åŒ…, ç¼–å†™æµ‹è¯•æœ‰ä¸¤ä¸ªå…³é”®å­— `describe` å’Œ `it`

- `describe` æ˜¯ä¸€ä¸ªâ€ç»Ÿé¢†å—â€, æ‰€æœ‰çš„ test functions éƒ½ä¼šåœ¨å®ƒâ€åä¸‹â€
- `it` è¡¨ç¤ºæ¯ä¸€ä¸ª test function

```
create_test.js
const assert = require('assert')
// assume we have a User model defined in src/user.js
const User = require('../src/user')

// after installing Mocha, we have global access
// to describe and it keywords
describe('Creating records', () => {
  it('saves a user', () => {
    const joe = new User({ name: "Joe" });
    joe.save();
    assert()
  });
});
```

## 7. NoSQL Databases

**Benefits of NoSQL**

- Easy for inserting and retrieving data, since they are contained in one block, in one json object
- Flexible schema, if a new attribute added, it is easy to just add / append to the object
- Scalability, horizontally partition the data (availability > consistency)
- Aggregation, find metrics and etc

**Drawbacks of NoSQL**

- Update = Delete + Insert, not built for update
- Not consistent, ACID is not guaranteed, do not support transactions
- Not read optimized. Read entire block find the attribute. But SQL, just need one column (read time compartively slow)
- Relations are not implicit
- JOINS are hard to accomplish, all manually

# MongoDB æ•°æ®åº“é«˜çº§è¿›é˜¶ - é›†ç¾¤å’Œå®‰å…¨

è¯¾ç¨‹ç›®æ ‡

- MongoDB çš„å‰¯æœ¬é›†ï¼šæ“ä½œã€ä¸»è¦æ¦‚å¿µã€æ•…éšœè½¬ç§»ã€é€‰ä¸¾è§„åˆ™
- MongoDB çš„åˆ†ç‰‡é›†ç¾¤ï¼šæ¦‚å¿µã€ä¼˜ç‚¹ã€æ“ä½œã€åˆ†ç‰‡ç­–ç•¥ã€æ•…éšœè½¬ç§»
- MongoDB çš„å®‰å…¨è®¤è¯

## 1. MongoDB å‰¯æœ¬é›† - Replica Sets

### 1.1 ç®€ä»‹

MongoDB ä¸­çš„å‰¯æœ¬é›†ï¼ˆReplica Setï¼‰æ˜¯ä¸€ç»„ç»´æŠ¤ç›¸åŒæ•°æ®é›†çš„ mongod æœåŠ¡ã€‚ å‰¯æœ¬é›†å¯æä¾›**å†—ä½™å’Œé«˜å¯ç”¨æ€§**ï¼Œæ˜¯æ‰€æœ‰ç”Ÿäº§éƒ¨ç½²çš„åŸºç¡€ã€‚

ä¹Ÿå¯ä»¥è¯´ï¼Œå‰¯æœ¬é›†ç±»ä¼¼äºæœ‰è‡ªåŠ¨æ•…éšœæ¢å¤åŠŸèƒ½çš„ä¸»ä»é›†ç¾¤ã€‚é€šä¿—çš„è®²å°±æ˜¯ç”¨*å¤šå°æœºå™¨è¿›è¡ŒåŒä¸€æ•°æ®çš„å¼‚æ­¥åŒæ­¥*ï¼Œä»è€Œä½¿å¤šå°æœºå™¨æ‹¥æœ‰åŒä¸€æ•°æ®çš„å¤šä¸ªå‰¯æœ¬ï¼Œå¹¶ä¸”å½“ä¸»åº“å½“æ‰æ—¶åœ¨ä¸éœ€è¦ç”¨æˆ·å¹²é¢„çš„æƒ…å†µä¸‹è‡ªåŠ¨åˆ‡æ¢å…¶ä»–å¤‡ä»½æœåŠ¡å™¨åšä¸»åº“ã€‚è€Œä¸”è¿˜å¯ä»¥**åˆ©ç”¨å‰¯æœ¬æœåŠ¡å™¨åšåªè¯»æœåŠ¡å™¨ï¼Œå®ç°è¯»å†™åˆ†ç¦»ï¼Œæé«˜è´Ÿè½½**ã€‚

#### å†—ä½™å’Œæ•°æ®å¯ç”¨æ€§

å¤åˆ¶æä¾›å†—ä½™å¹¶æé«˜æ•°æ®å¯ç”¨æ€§ã€‚ é€šè¿‡åœ¨ä¸åŒæ•°æ®åº“æœåŠ¡å™¨ä¸Šæä¾›å¤šä¸ªæ•°æ®å‰¯æœ¬ï¼Œå¤åˆ¶å¯æä¾›ä¸€å®šçº§åˆ«çš„å®¹é”™åŠŸèƒ½ï¼Œä»¥é˜²æ­¢ä¸¢å¤±å•ä¸ªæ•°æ®åº“æœåŠ¡å™¨ã€‚

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¤åˆ¶å¯ä»¥æä¾›å¢åŠ çš„è¯»å–æ€§èƒ½ï¼Œå› ä¸ºå®¢æˆ·ç«¯å¯ä»¥å°†è¯»å–æ“ä½œå‘é€åˆ°ä¸åŒçš„æœåŠ¡ä¸Šï¼Œ åœ¨ä¸åŒæ•°æ®ä¸­å¿ƒç»´æŠ¤æ•°æ®å‰¯æœ¬å¯ä»¥å¢åŠ åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„æ•°æ®ä½ç½®å’Œå¯ç”¨æ€§ã€‚ è¿˜å¯ä»¥ä¸ºä¸“ç”¨ç›®çš„ç»´æŠ¤å…¶ä»–å‰¯æœ¬ï¼Œä¾‹å¦‚ç¾éš¾æ¢å¤ï¼ŒæŠ¥å‘Šæˆ–å¤‡ä»½ã€‚

#### MongoDB ä¸­çš„å¤åˆ¶

å‰¯æœ¬é›†æ˜¯ä¸€ç»„ç»´æŠ¤ç›¸åŒæ•°æ®é›†çš„ mongod å®ä¾‹ã€‚ å‰¯æœ¬é›†åŒ…å«å¤šä¸ªæ•°æ®æ‰¿è½½èŠ‚ç‚¹å’Œå¯é€‰çš„ä¸€ä¸ªä»²è£èŠ‚ç‚¹ã€‚ åœ¨æ‰¿è½½æ•°æ®çš„èŠ‚ç‚¹ä¸­ï¼Œä¸€ä¸ªä¸”ä»…ä¸€ä¸ªæˆå‘˜è¢«è§†ä¸ºä¸»èŠ‚ç‚¹ï¼Œè€Œå…¶ä»–èŠ‚ç‚¹è¢«è§†ä¸ºæ¬¡è¦ï¼ˆä»ï¼‰èŠ‚ç‚¹ã€‚

ä¸»èŠ‚ç‚¹æ¥æ”¶æ‰€æœ‰å†™æ“ä½œã€‚ å‰¯æœ¬é›†åªèƒ½æœ‰ä¸€ä¸ªä¸»è¦èƒ½å¤Ÿç¡®è®¤å…·æœ‰ `{wï¼š"most"}` å†™å…¥å…³æ³¨çš„å†™å…¥; è™½ç„¶åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦ä¸€ä¸ª mongod å®ä¾‹å¯èƒ½æš‚æ—¶è®¤ä¸ºè‡ªå·±ä¹Ÿæ˜¯ä¸»è¦çš„ã€‚ä¸»è¦è®°å½•å…¶æ“ä½œæ—¥å¿—ä¸­çš„æ•°æ®é›†çš„æ‰€æœ‰ æ›´æ”¹ï¼Œå³ oplogã€‚

è¾…åŠ©(å‰¯æœ¬)èŠ‚ç‚¹å¤åˆ¶ä¸»èŠ‚ç‚¹çš„oplogå¹¶å°†æ“ä½œåº”ç”¨äºå…¶æ•°æ®é›†ï¼Œä»¥ä½¿è¾…åŠ©èŠ‚ç‚¹çš„æ•°æ®é›†åæ˜ ä¸»èŠ‚ç‚¹çš„æ•°æ® é›†ã€‚ å¦‚æœä¸»è¦äººå‘˜ä¸åœ¨ï¼Œåˆ™ç¬¦åˆæ¡ä»¶çš„ä¸­å­¦å°†ä¸¾è¡Œé€‰ä¸¾ä»¥é€‰å‡ºæ–°çš„ä¸»è¦äººå‘˜ã€‚

#### ä¸»ä»å¤åˆ¶å’Œå‰¯æœ¬é›†åŒºåˆ«

ä¸»ä»é›†ç¾¤å’Œå‰¯æœ¬é›†æœ€å¤§çš„åŒºåˆ«å°±æ˜¯**å‰¯æœ¬é›†æ²¡æœ‰å›ºå®šçš„â€ä¸»èŠ‚ç‚¹â€**ï¼›æ•´ä¸ªé›†ç¾¤ä¼šé€‰å‡ºä¸€ä¸ªâ€ä¸»èŠ‚ç‚¹â€ï¼Œå½“å…¶æŒ‚æ‰åï¼Œåˆåœ¨å‰©ä¸‹çš„ä»èŠ‚ç‚¹ä¸­é€‰ä¸­å…¶ä»–èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ï¼Œå‰¯æœ¬é›†æ€»æœ‰ä¸€ä¸ªæ´»è·ƒç‚¹ (ä¸»ã€primary) å’Œä¸€ä¸ªæˆ–å¤šä¸ªå¤‡ä»½èŠ‚ç‚¹ (ä»ã€secondary)

### 1.2 å‰¯æœ¬é›†çš„ä¸‰ä¸ªè§’è‰²

> å‰¯æœ¬é›†æœ‰ä¸¤ç§ç±»å‹ä¸‰ç§è§’è‰²

ä¸¤ç§ç±»å‹ï¼š

- ä¸»èŠ‚ç‚¹ï¼ˆPrimaryï¼‰ç±»å‹ï¼šæ•°æ®æ“ä½œçš„ä¸»è¦è¿æ¥ç‚¹ï¼Œ**å¯è¯»å†™**
- æ¬¡è¦ï¼ˆè¾…åŠ©ã€ä»ï¼‰èŠ‚ç‚¹ï¼ˆSecondaryï¼‰ç±»å‹ï¼šæ•°æ®å†—ä½™å¤‡ä»½èŠ‚ç‚¹ï¼Œå¯ä»¥**è¯»æˆ–é€‰ä¸¾**

ä¸‰ç§è§’è‰²ï¼š

- ä¸»è¦æˆå‘˜ï¼ˆPrimaryï¼‰ï¼šä¸»è¦æ¥æ”¶æ‰€æœ‰å†™æ“ä½œã€‚å°±æ˜¯ä¸»èŠ‚ç‚¹
- å‰¯æœ¬æˆå‘˜ï¼ˆReplicateï¼‰ï¼šä»ä¸»èŠ‚ç‚¹é€šè¿‡å¤åˆ¶æ“ä½œä»¥ç»´æŠ¤ç›¸åŒçš„æ•°æ®é›†ï¼Œå³å¤‡ä»½æ•°æ®ï¼Œ**ä¸å¯å†™æ“ä½œ**ï¼Œä½†å¯ä»¥è¯»æ“ä½œï¼ˆä½†éœ€è¦é…ç½®ï¼‰ã€‚æ˜¯é»˜è®¤çš„ä¸€ç§ä»èŠ‚ç‚¹ç±»å‹
- ä»²è£è€…ï¼ˆArbiterï¼‰ï¼š**ä¸ä¿ç•™ä»»ä½•æ•°æ®çš„å‰¯æœ¬ï¼Œåªå…·æœ‰æŠ•ç¥¨é€‰ä¸¾ä½œç”¨**ã€‚å½“ç„¶ä¹Ÿå¯ä»¥å°†ä»²è£æœåŠ¡å™¨ç»´æŠ¤ä¸ºå‰¯æœ¬é›†çš„ä¸€éƒ¨åˆ†ï¼Œå³å‰¯æœ¬æˆå‘˜åŒæ—¶ä¹Ÿå¯ä»¥æ˜¯ä»²è£è€…ã€‚ä¹Ÿæ˜¯ä¸€ç§ä»èŠ‚ç‚¹ç±»å‹ã€‚

![img](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/replica-set-primary-with-secondary-and-arbiter.bakedsvg.png)

> å…³äºä»²è£è€…çš„é¢å¤–è¯´æ˜ï¼š
>
> æ‚¨å¯ä»¥å°†é¢å¤–çš„ mongod å®ä¾‹æ·»åŠ åˆ°å‰¯æœ¬é›†ä½œä¸ºä»²è£è€…ã€‚ ä»²è£è€…ä¸ç»´æŠ¤æ•°æ®é›†ã€‚ ä»²è£è€…çš„ç›®çš„æ˜¯é€šè¿‡å“åº”å…¶ä»–å‰¯æœ¬é›†æˆå‘˜çš„å¿ƒè·³å’Œé€‰ä¸¾è¯·æ±‚æ¥ç»´æŠ¤å‰¯æœ¬é›†ä¸­çš„ä»²è£ã€‚ å› ä¸ºå®ƒä»¬ä¸å­˜å‚¨æ•°æ®é›†ï¼Œæ‰€ä»¥ä»²è£å™¨å¯ä»¥æ˜¯æä¾›å‰¯æœ¬é›†ä»²è£åŠŸèƒ½çš„å¥½æ–¹æ³•ï¼Œå…¶èµ„æºæˆæœ¬æ¯”å…·æœ‰æ•°æ®é›†çš„å…¨åŠŸèƒ½å‰¯æœ¬é›†æˆå‘˜æ›´ä¾¿å®œã€‚
>
> å¦‚æœæ‚¨çš„å‰¯æœ¬é›†å…·æœ‰å¶æ•°ä¸ªæˆå‘˜ï¼Œè¯·æ·»åŠ ä»²è£è€…ä»¥è·å¾—ä¸»è¦é€‰ä¸¾ä¸­çš„**å¤§å¤šæ•°**æŠ•ç¥¨ã€‚ ä»²è£è€…ä¸éœ€è¦ä¸“ç”¨ ç¡¬ä»¶ã€‚
>
> ä»²è£è€…å°†æ°¸è¿œæ˜¯ä»²è£è€…ï¼Œè€Œä¸»è¦äººå‘˜å¯èƒ½ä¼šé€€å‡ºå¹¶æˆä¸ºæ¬¡è¦äººå‘˜ï¼Œè€Œæ¬¡è¦äººå‘˜å¯èƒ½æˆä¸ºé€‰ä¸¾æœŸé—´çš„ä¸»è¦äººå‘˜ã€‚
>
> å¦‚æœä½ çš„å‰¯æœ¬+ä¸»èŠ‚ç‚¹çš„ä¸ªæ•°æ˜¯å¶æ•°ï¼Œå»ºè®®åŠ ä¸€ä¸ªä»²è£è€…ï¼Œå½¢æˆå¥‡æ•°ï¼Œå®¹æ˜“æ»¡è¶³å¤§å¤šæ•°çš„æŠ•ç¥¨ã€‚
>
> å¦‚æœä½ çš„å‰¯æœ¬+ä¸»èŠ‚ç‚¹çš„ä¸ªæ•°æ˜¯å¥‡æ•°ï¼Œå¯ä»¥ä¸åŠ ä»²è£è€…ã€‚
>
> > è¯´äººè¯å°±æ˜¯ [Paxos åè®®ç®—æ³•](https://zhenye-na.github.io/2020/02/07/[https://www.wikiwand.com/zh/Paxosç®—æ³•](https://www.wikiwand.com/zh/Paxosç®—æ³•)), å»ºè®®é˜…è¯»

### 1.3 åŠ¨æ‰‹å®ç°ä¸€ä¸ªå‰¯æœ¬é›†

#### 1.3.1 åˆ›å»ºèŠ‚ç‚¹

> ä½¿ç”¨ä¸€ä¸ªä¸»èŠ‚ç‚¹, ä¸€ä¸ªå‰¯èŠ‚ç‚¹, ä¸€ä¸ªä»²è£èŠ‚ç‚¹
>
> > 1. ç”¨ç«¯å£å·åŒºåˆ†ä¸åŒçš„èŠ‚ç‚¹
> > 2. å‰¯æœ¬é›†åç§°éƒ½æ˜¯ `myrs`

![img](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/replica-set-primary-with-secondary-and-arbiter.bakedsvg.png)

![img](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/image-20200507220642083.png)

> ä¸»èŠ‚ç‚¹ (PRIMARY), å‰¯èŠ‚ç‚¹ (SECONDARY), ä»¥åŠä»²è£èŠ‚ç‚¹ (ARBITER) çš„åˆ›å»ºè¿‡ç¨‹è¯¦è§é…å¥—æ–‡æ¡£

#### 1.3.2 åˆå§‹åŒ–é…ç½®å‰¯æœ¬é›†å’Œä¸»èŠ‚ç‚¹

ä½¿ç”¨å®¢æˆ·ç«¯å‘½ä»¤è¿æ¥ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†è¿™é‡Œå°½é‡è¦è¿æ¥ä¸»èŠ‚ç‚¹ (27017èŠ‚ç‚¹)

```
$ /usr/local/mongodb/bin/mongo --host=180.76.159.126 --port=27017
```

è¿æ¥ä¸Šä¹‹åï¼Œå¾ˆå¤šå‘½ä»¤æ— æ³•ä½¿ç”¨, æ¯”å¦‚ `show dbs` ç­‰ï¼Œå¿…é¡»åˆå§‹åŒ–å‰¯æœ¬é›†æ‰è¡Œ

åˆå§‹åŒ–æ–°çš„å‰¯æœ¬é›†

```
# example, `configuration` is optional
# rs.initiate(configuration)

$ rs.initiate()
{
  "info2" : "no configuration specified. Using a default configuration for the set",
  "me" : "<ip_address>:27017",
  "ok" : 1,
  "operationTime" : Timestamp(1565760476, 1),
  "$clusterTime" : {
    "clusterTime" : Timestamp(1565760476, 1),
    "signature" : {
    "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),
    "keyId" : NumberLong(0)
    }
  }
}
myrs:SECONDARY> <hit enter>
myrs:PRIMARY>
```

1. `ok` çš„å€¼ä¸º `1`, è¯´æ˜åˆ›å»ºæˆåŠŸ
2. å‘½ä»¤è¡Œæç¤ºç¬¦å‘ç”Ÿå˜åŒ–ï¼Œå˜æˆäº†ä¸€ä¸ªä»èŠ‚ç‚¹è§’è‰²ï¼Œæ­¤æ—¶é»˜è®¤ä¸èƒ½è¯»å†™ã€‚ç¨ç­‰ç‰‡åˆ»ï¼Œå›è½¦ï¼Œå˜æˆä¸»èŠ‚ ç‚¹ã€‚

#### 1.3.3 æŸ¥çœ‹é…ç½®

```
# configuration - optional
$ rs.conf(configuration)

myrs:PRIMARY> rs.conf()
{
  "_id" : "myrs",
  "version" : 1,
  "protocolVersion" : NumberLong(1),
  "writeConcernMajorityJournalDefault" : true,
  "members" : [{
    "_id" : 0,
    "host" : "180.76.159.126:27017",
    "arbiterOnly" : false,
    "buildIndexes" : true,
    "hidden" : false,
    "priority" : 1,
    "tags" : {},
    "slaveDelay" : NumberLong(0),
    "votes" : 1
  }],
  "settings" : {
    "chainingAllowed" : true,
    "heartbeatIntervalMillis" : 2000,
    "heartbeatTimeoutSecs" : 10,
    "electionTimeoutMillis" : 10000,
    "catchUpTimeoutMillis" : -1,
    "catchUpTakeoverDelayMillis" : 30000,
    "getLastErrorModes" : {},
    "getLastErrorDefaults" : {
      "w" : 1,
      "wtimeout" : 0
    },
    "replicaSetId" : ObjectId("5d539bdcd6a308e600d126bb")
  }
}
```

- `"_id" : "myrs"` ï¼šå‰¯æœ¬é›†çš„é…ç½®æ•°æ®å­˜å‚¨çš„ä¸»é”®å€¼ï¼Œé»˜è®¤å°±æ˜¯**å‰¯æœ¬é›†**çš„åå­—
- `"members"` ï¼šå‰¯æœ¬é›†æˆå‘˜æ•°ç»„ï¼Œæ­¤æ—¶åªæœ‰ä¸€ä¸ªï¼š `"host" : "180.76.159.126:27017"` ï¼Œè¯¥æˆå‘˜ä¸æ˜¯ä»²è£èŠ‚ç‚¹ï¼š `"arbiterOnly" : false` ï¼Œä¼˜å…ˆçº§ï¼ˆæƒé‡å€¼ï¼‰ï¼š `"priority" : 1`
- `"settings"` ï¼šå‰¯æœ¬é›†çš„å‚æ•°é…ç½®ã€‚

#### 1.3.4 æŸ¥çœ‹å‰¯æœ¬é›†çŠ¶æ€

è¿”å›åŒ…å«çŠ¶æ€ä¿¡æ¯çš„æ–‡æ¡£ã€‚æ­¤è¾“å‡ºä½¿ç”¨ä»å‰¯æœ¬é›†çš„å…¶ä»–æˆå‘˜å‘é€çš„å¿ƒè·³åŒ…ä¸­è·å¾—çš„æ•°æ®åæ˜ å‰¯æœ¬é›†çš„å½“ å‰çŠ¶æ€

```
$ rs.status()
```

#### 1.3.5 æ·»åŠ å‰¯æœ¬èŠ‚ç‚¹ä»¥åŠä»²è£èŠ‚ç‚¹

åœ¨ä¸»èŠ‚ç‚¹æ·»åŠ ä»èŠ‚ç‚¹ï¼Œå°†å…¶ä»–æˆå‘˜åŠ å…¥åˆ°å‰¯æœ¬é›†

```
$ rs.add(host, arbiterOnly)
```

æ·»åŠ ä¸€ä¸ªä»²è£èŠ‚ç‚¹åˆ°å‰¯æœ¬é›†

```
$ rs.addArb(host)
```

### 1.4 å‰¯æœ¬é›†çš„æ•°æ®è¯»å†™æ“ä½œ

å‰¯æœ¬èŠ‚ç‚¹ (SECONDARY) é»˜è®¤ä¸èƒ½ read , æ›´ä¸å¯èƒ½ write æ•°æ®, éœ€è¦

```
$ rs.slaveOk()
myrs:SECONDARY> show dbs; 

"errmsg" : "not master and slaveOk=false",

# éä¸»èŠ‚ç‚¹åŒæ—¶ slaveOk=false æ— æ³•è¯»å†™
```

æ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥, ä½†æ˜¯ä¼šæœ‰å»¶è¿Ÿ

------

ä»²è£è€…èŠ‚ç‚¹, ä¸å­˜æ”¾ä»»ä½•æ•°æ® -> `rs.slaveOk()` ä¹Ÿçœ‹ä¸åˆ°æ•°æ®

### 1.5 ä¸»èŠ‚ç‚¹çš„é€‰ä¸¾åŸåˆ™

MongoDBåœ¨å‰¯æœ¬é›†ä¸­ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œä¸»èŠ‚ç‚¹çš„é€‰ä¸¾ï¼Œä¸»èŠ‚ç‚¹é€‰ä¸¾çš„è§¦å‘æ¡ä»¶

1. ä¸»èŠ‚ç‚¹æ•…éšœ
2. ä¸»èŠ‚ç‚¹ç½‘ç»œä¸å¯è¾¾ (é»˜è®¤å¿ƒè·³ä¿¡æ¯ä¸º 10 ç§’)
3. äººå·¥å¹²é¢„ `rs.stepDown(600)`

ä¸€æ—¦è§¦å‘é€‰ä¸¾ï¼Œå°±è¦æ ¹æ®ä¸€å®šè§„åˆ™æ¥é€‰ä¸»èŠ‚ç‚¹

é€‰ä¸¾è§„åˆ™æ˜¯æ ¹æ®ç¥¨æ•°æ¥å†³å®šè°è·èƒœ

- ç¥¨æ•°æœ€é«˜ï¼Œä¸”è·å¾—äº†â€œå¤§å¤šæ•°â€æˆå‘˜çš„æŠ•ç¥¨æ”¯æŒçš„èŠ‚ç‚¹è·èƒœã€‚
  - â€œå¤§å¤šæ•°â€çš„å®šä¹‰ä¸ºï¼šå‡è®¾å¤åˆ¶é›†å†…æŠ•ç¥¨æˆå‘˜æ•°é‡ä¸ºNï¼Œåˆ™å¤§å¤šæ•°ä¸º N/2 + 1ã€‚ä¾‹å¦‚ï¼š3ä¸ªæŠ•ç¥¨æˆå‘˜ï¼Œ åˆ™å¤§å¤šæ•°çš„å€¼æ˜¯2ã€‚å½“å¤åˆ¶é›†å†…å­˜æ´»æˆå‘˜æ•°é‡ä¸è¶³å¤§å¤šæ•°æ—¶ï¼Œæ•´ä¸ªå¤åˆ¶é›†å°†æ— æ³•é€‰ä¸¾å‡ºPrimaryï¼Œ å¤åˆ¶é›†å°†æ— æ³•æä¾›å†™æœåŠ¡ï¼Œå¤„äºåªè¯»çŠ¶æ€ã€‚
- è‹¥ç¥¨æ•°ç›¸åŒï¼Œä¸”éƒ½è·å¾—äº†â€œå¤§å¤šæ•°â€æˆå‘˜çš„æŠ•ç¥¨æ”¯æŒçš„ï¼Œæ•°æ®æ–°çš„èŠ‚ç‚¹è·èƒœã€‚
  - æ•°æ®çš„æ–°æ—§æ˜¯é€šè¿‡æ“ä½œæ—¥å¿— oplog æ¥å¯¹æ¯”çš„ã€‚

åœ¨è·å¾—ç¥¨æ•°çš„æ—¶å€™ï¼Œä¼˜å…ˆçº§ï¼ˆpriorityï¼‰å‚æ•°å½±å“é‡å¤§ã€‚

å¯ä»¥é€šè¿‡è®¾ç½®ä¼˜å…ˆçº§ï¼ˆpriorityï¼‰æ¥è®¾ç½®é¢å¤–ç¥¨æ•°ã€‚ä¼˜å…ˆçº§å³æƒé‡ï¼Œå–å€¼ä¸º0-1000ï¼Œç›¸å½“äºå¯é¢å¤–å¢åŠ  0-1000çš„ç¥¨æ•°ï¼Œä¼˜å…ˆçº§çš„å€¼è¶Šå¤§ï¼Œå°±è¶Šå¯èƒ½è·å¾—å¤šæ•°æˆå‘˜çš„æŠ•ç¥¨ï¼ˆvotesï¼‰æ•°ã€‚æŒ‡å®šè¾ƒé«˜çš„å€¼å¯ä½¿æˆå‘˜ æ›´æœ‰èµ„æ ¼æˆä¸ºä¸»è¦æˆå‘˜ï¼Œæ›´ä½çš„å€¼å¯ä½¿æˆå‘˜æ›´ä¸ç¬¦åˆæ¡ä»¶ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼˜å…ˆçº§çš„å€¼æ˜¯ 1

### 1.6 æ•…éšœæµ‹è¯•

#### 1.6.1 å‰¯æœ¬èŠ‚ç‚¹æ•…éšœæµ‹è¯•

å…³é—­ `27018` å‰¯æœ¬èŠ‚ç‚¹

- ä¸»èŠ‚ç‚¹å’Œä»²è£èŠ‚ç‚¹å¯¹ `27018` çš„å¿ƒè·³å¤±è´¥ã€‚å› ä¸ºä¸»èŠ‚ç‚¹è¿˜åœ¨ï¼Œå› æ­¤ï¼Œæ²¡æœ‰è§¦å‘æŠ•ç¥¨é€‰ä¸¾ã€‚
- å¦‚æœæ­¤æ—¶ï¼Œåœ¨ä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®ã€‚å†å¯åŠ¨ä»èŠ‚ç‚¹ï¼Œä¼šå‘ç°ï¼Œ**ä¸»èŠ‚ç‚¹å†™å…¥çš„æ•°æ®**ï¼Œ**ä¼šè‡ªåŠ¨åŒæ­¥ç»™ä»èŠ‚ç‚¹**ã€‚

#### 1.6.2 ä¸»èŠ‚ç‚¹æ•…éšœæµ‹è¯•

å…³é—­27017èŠ‚ç‚¹

- ä»èŠ‚ç‚¹å’Œä»²è£èŠ‚ç‚¹å¯¹27017çš„å¿ƒè·³å¤±è´¥ï¼Œå½“å¤±è´¥è¶…è¿‡10ç§’ï¼Œæ­¤æ—¶å› ä¸ºæ²¡æœ‰ä¸»èŠ‚ç‚¹äº†ï¼Œä¼šè‡ªåŠ¨å‘èµ·æŠ•ç¥¨ã€‚
- è€Œå‰¯æœ¬èŠ‚ç‚¹åªæœ‰27018ï¼Œå› æ­¤ï¼Œå€™é€‰äººåªæœ‰ä¸€ä¸ªå°±æ˜¯27018ï¼Œå¼€å§‹æŠ•ç¥¨ã€‚
- 27019å‘27018æŠ•äº†ä¸€ç¥¨ï¼Œ27018æœ¬èº«è‡ªå¸¦ä¸€ç¥¨ï¼Œå› æ­¤å…±ä¸¤ç¥¨ï¼Œè¶…è¿‡äº†â€œå¤§å¤šæ•°â€
- 27019æ˜¯ä»²è£èŠ‚ç‚¹ï¼Œæ²¡æœ‰é€‰ä¸¾æƒï¼Œ27018ä¸å‘å…¶æŠ•ç¥¨ï¼Œå…¶ç¥¨æ•°æ˜¯0.

æœ€ç»ˆç»“æœï¼Œ27018æˆä¸ºä¸»èŠ‚ç‚¹ã€‚å…·å¤‡è¯»å†™åŠŸèƒ½ã€‚ åœ¨27018å†™å…¥æ•°æ®æŸ¥çœ‹ã€‚

#### 1.6.3 ä»²è£èŠ‚ç‚¹å’Œä¸»èŠ‚ç‚¹æ•…éšœ

å…ˆå…³æ‰ä»²è£èŠ‚ç‚¹27019ï¼Œ å…³æ‰ç°åœ¨çš„ä¸»èŠ‚ç‚¹27018 ç™»å½•27017å

- 27017ä»ç„¶æ˜¯ä»èŠ‚ç‚¹ï¼Œå‰¯æœ¬é›†ä¸­æ²¡æœ‰ä¸»èŠ‚ç‚¹äº†ï¼Œå¯¼è‡´æ­¤æ—¶ï¼Œå‰¯æœ¬é›†æ˜¯åªè¯»çŠ¶æ€ï¼Œ æ— æ³•å†™å…¥ã€‚
- ä¸ºå•¥ä¸é€‰ä¸¾äº†ï¼Ÿ
  - å› ä¸º27017çš„ç¥¨æ•°ï¼Œæ²¡æœ‰è·å¾—å¤§å¤šæ•°ï¼Œå³æ²¡æœ‰å¤§äºç­‰äº2ï¼Œå®ƒåªæœ‰é»˜è®¤çš„ä¸€ç¥¨ï¼ˆä¼˜å…ˆçº§ æ˜¯1ï¼‰
  - å¦‚æœè¦è§¦å‘é€‰ä¸¾ï¼Œéšä¾¿åŠ å…¥ä¸€ä¸ªæˆå‘˜å³å¯ã€‚
    - å¦‚æœåªåŠ å…¥27019ä»²è£èŠ‚ç‚¹æˆå‘˜ï¼Œåˆ™ä¸»èŠ‚ç‚¹ä¸€å®šæ˜¯27017ï¼Œå› ä¸ºæ²¡å¾—é€‰äº†ï¼Œä»²è£èŠ‚ç‚¹ä¸å‚ä¸é€‰ä¸¾ï¼Œ ä½†å‚ä¸æŠ•ç¥¨
    - å¦‚æœåªåŠ å…¥27018èŠ‚ç‚¹ï¼Œä¼šå‘èµ·é€‰ä¸¾ã€‚å› ä¸º27017å’Œ27018éƒ½æ˜¯ä¸¤ç¥¨ï¼Œåˆ™æŒ‰ç…§è°æ•°æ®æ–°ï¼Œè°å½“ä¸»èŠ‚ç‚¹ã€‚

#### 1.6.4 ä»²è£èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹æ•…éšœ

å…ˆå…³æ‰ä»²è£èŠ‚ç‚¹ `27019`ï¼Œå…³æ‰ç°åœ¨çš„å‰¯æœ¬èŠ‚ç‚¹ `27018`

10ç§’åï¼Œ`27017` ä¸»èŠ‚ç‚¹è‡ªåŠ¨é™çº§ä¸ºå‰¯æœ¬èŠ‚ç‚¹ã€‚ï¼ˆæœåŠ¡é™çº§ï¼‰

å‰¯æœ¬é›†ä¸å¯å†™æ•°æ®äº†ï¼Œå·²ç»æ•…éšœäº†ã€‚

## 2. åˆ†ç‰‡é›†ç¾¤ - Sharded Cluster

### 2.1 åˆ†ç‰‡æ¦‚å¿µ

åˆ†ç‰‡ (**sharding**) æ˜¯ä¸€ç§è·¨å¤šå°æœºå™¨åˆ†å¸ƒæ•°æ®çš„æ–¹æ³•ï¼Œ MongoDB ä½¿ç”¨åˆ†ç‰‡æ¥æ”¯æŒå…·æœ‰éå¸¸å¤§çš„æ•°æ®é›†å’Œé«˜ååé‡æ“ä½œçš„éƒ¨ç½²ã€‚

æ¢å¥è¯è¯´ï¼šåˆ†ç‰‡ (sharding) æ˜¯æŒ‡å°†æ•°æ®æ‹†åˆ†ï¼Œå°†å…¶åˆ†æ•£å­˜åœ¨ä¸åŒçš„æœºå™¨ä¸Šçš„è¿‡ç¨‹ã€‚æœ‰æ—¶ä¹Ÿç”¨åˆ†åŒº (**partitioning**) æ¥è¡¨ç¤ºè¿™ä¸ªæ¦‚å¿µã€‚å°†æ•°æ®åˆ†æ•£åˆ°ä¸åŒçš„æœºå™¨ä¸Šï¼Œä¸éœ€è¦åŠŸèƒ½å¼ºå¤§çš„å¤§å‹è®¡ç®—æœºå°±å¯ä»¥å‚¨å­˜æ›´å¤šçš„æ•°æ®ï¼Œå¤„ç†æ›´å¤šçš„è´Ÿè½½ã€‚

å…·æœ‰å¤§å‹æ•°æ®é›†æˆ–é«˜ååé‡åº”ç”¨ç¨‹åºçš„æ•°æ®åº“ç³»ç»Ÿå¯ä»¥ä¼šæŒ‘æˆ˜å•ä¸ªæœåŠ¡å™¨çš„å®¹é‡ã€‚ä¾‹å¦‚ï¼Œé«˜æŸ¥è¯¢ç‡ä¼šè€—å°½æœåŠ¡å™¨çš„ CPU å®¹é‡ã€‚å·¥ä½œé›†å¤§å°å¤§äºç³»ç»Ÿçš„ RAM ä¼šå¼ºè°ƒç£ç›˜é©±åŠ¨å™¨çš„ `I/O` å®¹é‡ã€‚

æœ‰ä¸¤ç§è§£å†³ç³»ç»Ÿå¢é•¿çš„æ–¹æ³•ï¼š**å‚ç›´æ‰©å±•**å’Œ**æ°´å¹³æ‰©å±•**ã€‚

- **å‚ç›´æ‰©å±•**æ„å‘³ç€**å¢åŠ å•ä¸ªæœåŠ¡å™¨çš„å®¹é‡**ï¼Œä¾‹å¦‚ä½¿ç”¨æ›´å¼ºå¤§çš„CPUï¼Œæ·»åŠ æ›´å¤šRAMæˆ–å¢åŠ å­˜å‚¨ç©ºé—´é‡ã€‚å¯ ç”¨æŠ€æœ¯çš„å±€é™æ€§å¯èƒ½ä¼šé™åˆ¶å•ä¸ªæœºå™¨å¯¹äºç»™å®šå·¥ä½œè´Ÿè½½è€Œè¨€è¶³å¤Ÿå¼ºå¤§ã€‚æ­¤å¤–åŸºäºäº‘çš„æä¾›å•†åŸºäºå¯ç”¨çš„ç¡¬ä»¶é…ç½®å…·æœ‰ç¡¬æ€§ä¸Šé™ã€‚ç»“æœï¼Œå‚ç›´ç¼©æ”¾æœ‰å®é™…çš„æœ€å¤§å€¼ã€‚
- **æ°´å¹³æ‰©å±•**æ„å‘³ç€**åˆ’åˆ†ç³»ç»Ÿæ•°æ®é›†å¹¶åŠ è½½å¤šä¸ªæœåŠ¡å™¨**ï¼Œæ·»åŠ å…¶ä»–æœåŠ¡å™¨ä»¥æ ¹æ®éœ€è¦å¢åŠ å®¹é‡ã€‚è™½ç„¶å•ä¸ªæœºå™¨çš„æ€»ä½“é€Ÿåº¦æˆ–å®¹é‡å¯èƒ½ä¸é«˜ï¼Œä½†æ¯å°æœºå™¨å¤„ç†æ•´ä¸ªå·¥ä½œè´Ÿè½½çš„å­é›†ï¼Œå¯èƒ½æä¾›æ¯”å•ä¸ªé«˜é€Ÿå¤§å®¹é‡æœåŠ¡å™¨æ›´é«˜çš„æ•ˆç‡ã€‚æ‰©å±•éƒ¨ç½²å®¹é‡åªéœ€è¦æ ¹æ®éœ€è¦æ·»åŠ é¢å¤–çš„æœåŠ¡å™¨ï¼Œè¿™å¯èƒ½æ¯”å•ä¸ªæœºå™¨çš„é«˜ç«¯ç¡¬ä»¶çš„æ€»ä½“ æˆæœ¬æ›´ä½ã€‚æƒè¡¡æ˜¯åŸºç¡€æ¶æ„å’Œéƒ¨ç½²ç»´æŠ¤çš„å¤æ‚æ€§å¢åŠ ã€‚

MongoDB æ”¯æŒé€šè¿‡**åˆ†ç‰‡è¿›è¡Œæ°´å¹³æ‰©å±•**ã€‚

### 2.2 åˆ†ç‰‡é›†ç¾¤åŒ…å«çš„ç»„ä»¶

MongoDB åˆ†ç‰‡ç¾¤é›†åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

- åˆ†ç‰‡ï¼ˆå­˜å‚¨ï¼‰ï¼šæ¯ä¸ªåˆ†ç‰‡åŒ…å«åˆ†ç‰‡æ•°æ®çš„å­é›†ã€‚ æ¯ä¸ªåˆ†ç‰‡éƒ½å¯ä»¥éƒ¨ç½²ä¸ºå‰¯æœ¬é›†ã€‚
- mongos ï¼ˆè·¯ç”±ï¼‰ï¼šmongoså……å½“æŸ¥è¯¢è·¯ç”±å™¨ï¼Œåœ¨å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå’Œåˆ†ç‰‡é›†ç¾¤ä¹‹é—´æä¾›æ¥å£ã€‚
- conï¬g servers ï¼ˆâ€è°ƒåº¦â€ çš„é…ç½®ï¼‰ï¼šé…ç½®æœåŠ¡å™¨å­˜å‚¨ç¾¤é›†çš„å…ƒæ•°æ®å’Œé…ç½®è®¾ç½®ã€‚ ä»MongoDB 3.4 å¼€å§‹ï¼Œå¿…é¡»å°†é…ç½®æœåŠ¡å™¨éƒ¨ç½²ä¸ºå‰¯æœ¬é›†ï¼ˆCSRSï¼‰ã€‚

![img](https://docs.mongodb.com/manual/_images/sharded-cluster-production-architecture.bakedsvg.svg)

### 2.3 åˆ†ç‰‡é›†ç¾¤æ¶æ„ç›®æ ‡

> ä¸¤ä¸ªåˆ†ç‰‡èŠ‚ç‚¹å‰¯æœ¬é›†ï¼ˆ3+3ï¼‰+ ä¸€ä¸ªé…ç½®èŠ‚ç‚¹å‰¯æœ¬é›†ï¼ˆ3ï¼‰+ ä¸¤ä¸ªè·¯ç”±èŠ‚ç‚¹ï¼ˆ2ï¼‰ï¼Œå…± `11` ä¸ªæœåŠ¡èŠ‚ç‚¹

![img](https://raw.githubusercontent.com/Zhenye-Na/img-hosting-picgo/master/img/image-20200513214148083.png)

å‰¯æœ¬é›†çš„åˆ›å»ºè¯¦è§æ–‡æ¡£ä»¥åŠè§†é¢‘

æ·»åŠ åˆ†ç‰‡

```
$ sh.addShard("IP:Port", "IP:Port", "IP:Port")
```

æŸ¥çœ‹åˆ†ç‰‡çŠ¶æ€æƒ…å†µ

```
$ sh.status()
```

å¦‚æœæ·»åŠ åˆ†ç‰‡å¤±è´¥ï¼Œéœ€è¦å…ˆæ‰‹åŠ¨ç§»é™¤åˆ†ç‰‡ï¼Œæ£€æŸ¥æ·»åŠ åˆ†ç‰‡çš„ä¿¡æ¯çš„æ­£ç¡®æ€§åï¼Œå†æ¬¡æ·»åŠ åˆ†ç‰‡ã€‚ ç§»é™¤åˆ†ç‰‡:

```
$ use admin
$ db.runCommand( { removeShard: "myshardrs02" } )
```

- å¦‚æœåªå‰©ä¸‹æœ€åä¸€ä¸ª shardï¼Œæ˜¯æ— æ³•åˆ é™¤çš„
- ç§»é™¤æ—¶ä¼šè‡ªåŠ¨è½¬ç§»åˆ†ç‰‡æ•°æ®ï¼Œéœ€è¦ä¸€ä¸ªæ—¶é—´è¿‡ç¨‹
- å®Œæˆåï¼Œå†æ¬¡æ‰§è¡Œåˆ é™¤åˆ†ç‰‡å‘½ä»¤æ‰èƒ½çœŸæ­£åˆ é™¤

å¼€å¯åˆ†ç‰‡åŠŸèƒ½

```
$ sh.enableSharding("articledb")
$ sh.enableSharding("åº“å")

$ sh.shardCollection("åº“å.é›†åˆå",{"key":1})
```

é›†åˆåˆ†ç‰‡ï¼Œä½¿ç”¨ `sh.shardCollection()` æ–¹æ³•æŒ‡å®šé›†åˆå’Œåˆ†ç‰‡é”®

```
$ sh.shardCollection(namespace, key, unique)
```

å¯¹é›†åˆè¿›è¡Œåˆ†ç‰‡æ—¶, ä½ éœ€è¦é€‰æ‹©ä¸€ä¸ª **ç‰‡é”®** (Shard Key) shard key æ˜¯æ¯æ¡è®°å½•éƒ½å¿…é¡»åŒ…å«çš„, ä¸”å»ºç«‹äº†**ç´¢å¼•**çš„å•ä¸ªå­—æ®µæˆ–å¤åˆå­—æ®µ, MongoDBæŒ‰ç…§ç‰‡é”®å°†æ•°æ®åˆ’åˆ†åˆ°ä¸åŒçš„æ•°æ®å—ä¸­,å¹¶å°†æ•°æ®å—å‡è¡¡åœ°åˆ†å¸ƒåˆ°æ‰€æœ‰åˆ†ç‰‡ä¸­. ä¸ºäº†æŒ‰ç…§ç‰‡é”®åˆ’åˆ†æ•°æ®å—, MongoDBä½¿ç”¨**åŸºäºå“ˆå¸Œ**çš„åˆ†ç‰‡æ–¹å¼ï¼ˆéšæœºå¹³å‡åˆ†é…ï¼‰æˆ–è€…**åŸºäºèŒƒå›´**çš„åˆ†ç‰‡æ–¹å¼ï¼ˆæ•°å€¼å¤§å°åˆ†é…ï¼‰ ã€‚

> ç”¨ä»€ä¹ˆå­—æ®µå½“ç‰‡é”®éƒ½å¯ä»¥ï¼Œå¦‚ï¼šnicknameä½œä¸ºç‰‡é”®ï¼Œä½†ä¸€å®šæ˜¯å¿…å¡«å­—æ®µã€‚

### åˆ†ç‰‡ç­–ç•¥(è§„åˆ™)

#### å“ˆå¸Œç­–ç•¥

å¯¹äº **åŸºäºå“ˆå¸Œ** çš„åˆ†ç‰‡ , MongoDBè®¡ç®—ä¸€ä¸ªå­—æ®µçš„å“ˆå¸Œå€¼, å¹¶ç”¨è¿™ä¸ªå“ˆå¸Œå€¼æ¥åˆ›å»ºæ•°æ®å—.

åœ¨ä½¿ç”¨åŸºäºå“ˆå¸Œåˆ†ç‰‡çš„ç³»ç»Ÿä¸­, æ‹¥æœ‰â€ç›¸è¿‘â€ç‰‡é”®çš„æ–‡æ¡£**å¾ˆå¯èƒ½ä¸ä¼š**å­˜å‚¨åœ¨åŒä¸€ä¸ªæ•°æ®å—ä¸­, å› æ­¤**æ•°æ®çš„åˆ†ç¦»æ€§**æ›´å¥½ä¸€äº›.

#### èŒƒå›´ç­–ç•¥

å¯¹äº **åŸºäºèŒƒå›´** çš„åˆ†ç‰‡ , MongoDB æŒ‰ç…§ç‰‡é”®çš„èŒƒå›´æŠŠæ•°æ®åˆ†æˆä¸åŒéƒ¨åˆ†. å‡è®¾æœ‰ä¸€ä¸ªæ•°å­—çš„ç‰‡é”® : æƒ³è±¡ä¸€ä¸ªä»è´Ÿæ— ç©·åˆ°æ­£æ— ç©·çš„ç›´çº¿,æ¯ä¸€ä¸ªç‰‡é”®çš„å€¼éƒ½åœ¨ç›´çº¿ä¸Šç”»äº†ä¸€ä¸ªç‚¹. MongoDBæŠŠè¿™æ¡ç›´çº¿åˆ’åˆ†ä¸ºæ›´çŸ­çš„ä¸é‡å çš„ç‰‡æ®µ, å¹¶ç§°ä¹‹ä¸ºæ•°æ®å— ,æ¯ä¸ªæ•°æ®å—åŒ…å«äº†ç‰‡é”®åœ¨ä¸€å®šèŒƒå›´å†…çš„æ•°æ®.

åœ¨ä½¿ç”¨ç‰‡é”®åšèŒƒå›´åˆ’åˆ†çš„ç³»ç»Ÿä¸­, æ‹¥æœ‰â€ç›¸è¿‘â€ç‰‡é”®çš„æ–‡æ¡£**å¾ˆå¯èƒ½å­˜å‚¨åœ¨åŒä¸€ä¸ªæ•°æ®å—**ä¸­, å› æ­¤ä¹Ÿä¼šå­˜å‚¨åœ¨åŒä¸€ä¸ªåˆ†ç‰‡ä¸­.

#### åŸºäºèŒƒå›´çš„åˆ†ç‰‡æ–¹å¼ä¸åŸºäºå“ˆå¸Œçš„åˆ†ç‰‡æ–¹å¼æ€§èƒ½å¯¹æ¯”

åŸºäºèŒƒå›´çš„åˆ†ç‰‡æ–¹å¼æä¾›äº†æ›´é«˜æ•ˆçš„èŒƒå›´æŸ¥è¯¢, ç»™å®šä¸€ä¸ªç‰‡é”®çš„èŒƒå›´,åˆ†å‘è·¯ç”±å¯ä»¥å¾ˆç®€å•åœ°ç¡®å®šå“ªä¸ªæ•° æ®å—å­˜å‚¨äº†è¯·æ±‚éœ€è¦çš„æ•°æ®,å¹¶å°†è¯·æ±‚è½¬å‘åˆ°ç›¸åº”çš„åˆ†ç‰‡ä¸­. ä¸è¿‡, åŸºäºèŒƒå›´çš„åˆ†ç‰‡ä¼šå¯¼è‡´æ•°æ®åœ¨ä¸åŒåˆ†ç‰‡ä¸Šçš„ä¸å‡è¡¡,æœ‰æ—¶å€™,å¸¦æ¥çš„æ¶ˆæä½œç”¨ä¼šå¤§äºæŸ¥è¯¢æ€§èƒ½çš„ç§¯æä½œç”¨. æ¯”å¦‚, å¦‚æœç‰‡é”®æ‰€åœ¨çš„å­—æ®µæ˜¯çº¿æ€§å¢é•¿çš„, ä¸€å®šæ—¶é—´å†…çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè½åˆ°æŸä¸ªå›ºå®šçš„æ•°æ®å—ä¸­, æœ€ç»ˆå¯¼è‡´åˆ†å¸ƒåœ¨åŒä¸€ä¸ªåˆ†ç‰‡ä¸­. åœ¨è¿™ç§æƒ…å†µä¸‹, ä¸€å°éƒ¨åˆ†åˆ†ç‰‡æ‰¿è½½äº†é›†ç¾¤å¤§éƒ¨åˆ†çš„æ•°æ®,ç³»ç»Ÿå¹¶ä¸èƒ½å¾ˆå¥½åœ°è¿›è¡Œ æ‰©å±•. ä¸æ­¤ç›¸æ¯”, åŸºäºå“ˆå¸Œçš„åˆ†ç‰‡æ–¹å¼ä»¥èŒƒå›´æŸ¥è¯¢æ€§èƒ½çš„æŸå¤±ä¸ºä»£ä»·, ä¿è¯äº†é›†ç¾¤ä¸­æ•°æ®çš„å‡è¡¡.å“ˆå¸Œå€¼çš„éšæœºæ€§ ä½¿æ•°æ®éšæœºåˆ†å¸ƒåœ¨æ¯ä¸ªæ•°æ®å—ä¸­, å› æ­¤ä¹Ÿéšæœºåˆ†å¸ƒåœ¨ä¸åŒåˆ†ç‰‡ä¸­.ä½†æ˜¯ä¹Ÿæ­£ç”±äºéšæœºæ€§, ä¸€ä¸ªèŒƒå›´æŸ¥è¯¢å¾ˆéš¾ ç¡®å®šåº”è¯¥è¯·æ±‚å“ªäº›åˆ†ç‰‡, é€šå¸¸ä¸ºäº†è¿”å›éœ€è¦çš„ç»“æœ,éœ€è¦è¯·æ±‚æ‰€æœ‰åˆ†ç‰‡.

å¦‚æ— ç‰¹æ®Šæƒ…å†µï¼Œä¸€èˆ¬æ¨èä½¿ç”¨ `Hash Sharding`. è€Œä½¿ç”¨ `_id` ä½œä¸ºç‰‡é”®æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒæ˜¯å¿…æœ‰çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨æ•°æ®æ–‡æ¡£ `_id` çš„å“ˆå¸Œä½œä¸ºç‰‡é”®ã€‚ è¿™ä¸ªæ–¹æ¡ˆèƒ½å¤Ÿæ˜¯çš„è¯»å’Œå†™éƒ½èƒ½å¤Ÿå¹³å‡åˆ†å¸ƒï¼Œå¹¶ä¸”å®ƒèƒ½å¤Ÿä¿è¯æ¯ä¸ªæ–‡æ¡£éƒ½æœ‰ä¸åŒçš„ç‰‡é”®æ‰€ä»¥æ•°æ®å—èƒ½å¤Ÿå¾ˆ ç²¾ç»†ã€‚ ä¼¼ä¹è¿˜æ˜¯ä¸å¤Ÿå®Œç¾ï¼Œå› ä¸ºè¿™æ ·çš„è¯å¯¹å¤šä¸ªæ–‡æ¡£çš„æŸ¥è¯¢å¿…å°†å‘½ä¸­æ‰€æœ‰çš„åˆ†ç‰‡ã€‚è™½è¯´å¦‚æ­¤ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§æ¯”è¾ƒ å¥½çš„æ–¹æ¡ˆäº†ã€‚ ç†æƒ³åŒ–çš„ `shard key` å¯ä»¥è®© documents å‡åŒ€åœ°åœ¨é›†ç¾¤ä¸­åˆ†å¸ƒ

## 3. å®‰å…¨è®¤è¯

### 3.1 MongoDBçš„ç”¨æˆ·å’Œè§’è‰²æƒé™ç®€ä»‹

é»˜è®¤æƒ…å†µä¸‹ï¼ŒMongoDBå®ä¾‹å¯åŠ¨è¿è¡Œæ—¶æ˜¯æ²¡æœ‰å¯ç”¨ç”¨æˆ·è®¿é—®æƒé™æ§åˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®ä¾‹æœ¬æœºæœåŠ¡ å™¨ä¸Šéƒ½å¯ä»¥éšæ„è¿æ¥åˆ°å®ä¾‹è¿›è¡Œå„ç§æ“ä½œï¼ŒMongoDBä¸ä¼šå¯¹è¿æ¥å®¢æˆ·ç«¯è¿›è¡Œç”¨æˆ·éªŒè¯ï¼Œè¿™æ˜¯éå¸¸å±é™© çš„ã€‚

mongodbå®˜ç½‘ä¸Šè¯´ï¼Œä¸ºäº†èƒ½ä¿éšœmongodbçš„å®‰å…¨å¯ä»¥åšä»¥ä¸‹å‡ ä¸ªæ­¥éª¤

1. ä½¿ç”¨æ–°çš„ç«¯å£ï¼Œé»˜è®¤çš„ 27017 ç«¯å£å¦‚æœä¸€æ—¦çŸ¥é“äº† ip å°±èƒ½è¿æ¥ä¸Šï¼Œä¸å¤ªå®‰å…¨
2. è®¾ç½® mongodb çš„ç½‘ç»œç¯å¢ƒï¼Œæœ€å¥½å°† mongodb éƒ¨ç½²åˆ°å…¬å¸æœåŠ¡å™¨å†…ç½‘ï¼Œè¿™æ ·å¤–ç½‘æ˜¯è®¿é—®ä¸åˆ°çš„ã€‚å…¬ å¸å†…éƒ¨è®¿é—®ä½¿ç”¨ vpn ç­‰
3. å¼€å¯å®‰å…¨è®¤è¯ã€‚è®¤è¯è¦åŒæ—¶è®¾ç½®æœåŠ¡å™¨ä¹‹é—´çš„å†…éƒ¨è®¤è¯æ–¹å¼ï¼ŒåŒæ—¶è¦è®¾ç½®å®¢æˆ·ç«¯è¿æ¥åˆ°é›†ç¾¤çš„è´¦å· å¯†ç è®¤è¯æ–¹å¼ã€‚

ä¸ºäº†å¼ºåˆ¶å¼€å¯ç”¨æˆ·è®¿é—®æ§åˆ¶(ç”¨æˆ·éªŒè¯)ï¼Œåˆ™éœ€è¦åœ¨MongoDBå®ä¾‹å¯åŠ¨æ—¶ä½¿ç”¨é€‰é¡¹ â€“auth æˆ–åœ¨æŒ‡å®šå¯åŠ¨ é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é€‰é¡¹ `auth=true`

åœ¨å¼€å§‹ä¹‹å‰éœ€è¦äº†è§£ä¸€ä¸‹æ¦‚å¿µ

#### å¯ç”¨è®¿é—®æ§åˆ¶

- MongoDBä½¿ç”¨çš„æ˜¯åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(Role-Based Access Control,RBAC)æ¥ç®¡ç†ç”¨æˆ·å¯¹å®ä¾‹çš„è®¿é—®ã€‚ é€šè¿‡å¯¹ç”¨æˆ·æˆäºˆä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²æ¥æ§åˆ¶ç”¨æˆ·è®¿é—®æ•°æ®åº“èµ„æºçš„æƒé™å’Œæ•°æ®åº“æ“ä½œçš„æƒé™ï¼Œåœ¨å¯¹ç”¨æˆ·åˆ†é… è§’è‰²ä¹‹å‰ï¼Œç”¨æˆ·æ— æ³•è®¿é—®å®ä¾‹
- åœ¨å®ä¾‹å¯åŠ¨æ—¶æ·»åŠ é€‰é¡¹ â€“auth æˆ–æŒ‡å®šå¯åŠ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é€‰é¡¹ `auth=true`

#### è§’è‰²

åœ¨MongoDBä¸­é€šè¿‡è§’è‰²å¯¹ç”¨æˆ·æˆäºˆç›¸åº”æ•°æ®åº“èµ„æºçš„æ“ä½œæƒé™ï¼Œæ¯ä¸ªè§’è‰²å½“ä¸­çš„æƒé™å¯ä»¥æ˜¾å¼æŒ‡å®šï¼Œ ä¹Ÿå¯ä»¥é€šè¿‡ç»§æ‰¿å…¶ä»–è§’è‰²çš„æƒé™ï¼Œæˆ–è€…ä¸¤éƒ½éƒ½å­˜åœ¨çš„æƒé™ã€‚

#### æƒé™

æƒé™ç”±æŒ‡å®šçš„æ•°æ®åº“èµ„æº(resource)ä»¥åŠå…è®¸åœ¨æŒ‡å®šèµ„æºä¸Šè¿›è¡Œçš„æ“ä½œ(action)ç»„æˆ

1. èµ„æº(resource)åŒ…æ‹¬ï¼šæ•°æ®åº“ã€é›†åˆã€éƒ¨åˆ†é›†åˆå’Œé›†ç¾¤
2. æ“ä½œ(action)åŒ…æ‹¬ï¼šå¯¹èµ„æºè¿›è¡Œçš„å¢ã€åˆ ã€æ”¹ã€æŸ¥(CRUD)æ“ä½œ

åœ¨è§’è‰²å®šä¹‰æ—¶å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå·²å­˜åœ¨çš„è§’è‰²ï¼Œæ–°åˆ›å»ºçš„è§’è‰²ä¼šç»§æ‰¿åŒ…å«çš„è§’è‰²æ‰€æœ‰çš„æƒé™ã€‚åœ¨åŒä¸€ ä¸ªæ•°æ®åº“ä¸­ï¼Œæ–°åˆ›å»ºè§’è‰²å¯ä»¥ç»§æ‰¿å…¶ä»–è§’è‰²çš„æƒé™ï¼Œåœ¨ admin æ•°æ®åº“ä¸­åˆ›å»ºçš„è§’è‰²å¯ä»¥ç»§æ‰¿åœ¨å…¶å®ƒä»»æ„ æ•°æ®åº“ä¸­è§’è‰²çš„æƒé™ã€‚

```
# æŸ¥è¯¢æ‰€æœ‰è§’è‰²æƒé™(ä»…ç”¨æˆ·è‡ªå®šä¹‰è§’è‰²)
$ db.runCommand({ rolesInfo: 1 })

# æŸ¥è¯¢æ‰€æœ‰è§’è‰²æƒé™(åŒ…å«å†…ç½®è§’è‰²)
$ db.runCommand({ rolesInfo: 1, showBuiltinRoles: true })


# æŸ¥è¯¢å½“å‰æ•°æ®åº“ä¸­çš„æŸè§’è‰²çš„æƒé™
$ db.runCommand({ rolesInfo: "<rolename>" })

# æŸ¥è¯¢å…¶å®ƒæ•°æ®åº“ä¸­æŒ‡å®šçš„è§’è‰²æƒé™
$ db.runCommand({ rolesInfo: { role: "<rolename>", db: "<database>" } }

# æŸ¥è¯¢å¤šä¸ªè§’è‰²æƒé™
$ db.runCommand({
  rolesInfo: [
    "<rolename>",
    {
      role: "<rolename>",
      db: "<database>"
    },
    ...

  ]
})
```

å¸¸ç”¨çš„å†…ç½®è§’è‰²ï¼š

- æ•°æ®åº“ç”¨æˆ·è§’è‰²ï¼šreadã€readWrite
- æ‰€æœ‰æ•°æ®åº“ç”¨æˆ·è§’è‰²ï¼šreadAnyDatabaseã€readWriteAnyDatabaseã€ userAdminAnyDatabaseã€dbAdminAnyDatabase
- æ•°æ®åº“ç®¡ç†è§’è‰²ï¼š dbAdminã€dbOwnerã€userAdmin
- é›†ç¾¤ç®¡ç†è§’è‰²ï¼š clusterAdminã€clusterManagerã€clusterMonitorã€hostManager
- å¤‡ä»½æ¢å¤è§’è‰²ï¼š backupã€restore
- è¶…çº§ç”¨æˆ·è§’è‰²ï¼š root
- å†…éƒ¨è§’è‰²ï¼š system